---
title: "6-technical-variability: auto"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparation

## Libraries
```{r}
library(SummarizedExperiment)
library(PCAtools)
library(ComplexHeatmap)
library(sva)
library(tidyr)
library(dplyr)
library(purrr)
library(tibble)
library(ggplot2)
library(pheatmap)
library(ggpubr)
library(reshape2)
library(viridis)
library(RColorBrewer)
library(ggbreak) 
library(limma)
```

## Functions
```{r}
source("~/single-cell-histone-ptm/functions.R")
```

## Load histone standards
```{r}
setwd("~/single-cell-histone-ptm/3-calibration-curves/auto/histone-standards/filtered")

obj.filter <- readRDS("obj.filter.RDS")
obj.filter$multiplier <- factor(obj.filter$multiplier)
```

### Save object
```{r}
setwd("~/single-cell-histone-ptm/6-technical-variability/auto")

saveRDS(obj.filter, "obj.filter.RDS")
```

## Load bulk data from previous studes
- The first two studies are from HeLa cells and are multiple injections representing technical replicates
- THe third study are biological replicates of T cells
```{r}
# Simone's studies
setwd("~/single-cell-histone-ptm/1-data/bulk/simone")

# load
bottomup <- read.csv("Bottom-up vs middle-down (Anal Chem 2015) - cleaned data.csv", header = TRUE)
dialowres <- read.csv("DIA low resolution (Anal Chem 2015) - cleaned data.csv", header = TRUE)
met.labeling <- read.csv("Metabolic labeling (Sci Rep 2019) - cleaned data.csv")

# Convert peptide note format
bottomup <- bottomup %>% 
  mutate(Peptide.Note.New = sapply(Peptide.Note, format_peptide_note),
         Peptide.Note.New = paste(Protein, Peptide.Note.New, sep = "-"))
  
dialowres <- dialowres %>% 
  mutate(Peptide.Note.New = sapply(Peptide.Note, format_peptide_note),
         Peptide.Note.New = paste(Protein, Peptide.Note.New, sep = "-"))

met.labeling <- met.labeling %>% 
  mutate(Peptide.Note.New = sapply(Peptide.Note, format_peptide_note),
         Peptide.Note.New = paste(Protein, Peptide.Note.New, sep = "-"))

# Malvina's studies
setwd("~/single-cell-histone-ptm/1-data/bulk/malvina")

# data is normalized as: Light(PTM)/Heavy(PTM) divided by Light(NORM)/Heavy(NORM) - level 3
# A1/A2/A3 is DMSO controls, which is what we want to use to calculate CV
# sebrafish study is level 4 - row median normalization

# meta <- df[c(1:21),-c(2:12)]
# rownames(meta) <- meta$id
# meta$id <- NULL
# meta <- t(meta)
# meta <- as.data.frame(meta)

lincs <- load_LINCS_gct(list.files(pattern = "LINCS"),
                        c("pr_gcp_base_peptide", "pr_gcp_histone_mark","A01", "A02", "A03"))

```

# Filtering

## Peptides
- Filter based on filtering on cell data
```{r}
setwd("~/single-cell-histone-ptm/4-normalization/auto")

obj.cells <- readRDS("obj.filter.ratio.multi.RDS")

obj.filter <- obj.filter[rownames(obj.filter) %in% rownames(obj.cells[["ptm.ratio"]]),]

# share peptide sequence information
rowData(obj.filter)
```

## Samples
- remove empty
```{r}
obj.filter <- obj.filter[,obj.filter$multiplier != 0]
```

# Normalization

## Peptide ratio

### MS1 ratio
```{r}
setwd("/Users/ronaldcutler/Dropbox (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/6-technical-variability/auto/normalization")

ptm.ratio.ms1 <- calculate_ptm_ratio(obj.filter, assay = "MS1")

pdf("MS1.ratio_cell.pdf",
    width = 8,
    height = 8)
ggplot(ptm.ratio.ms1, aes(x = as.factor(run_id), y = ratio, fill = as.factor(experiment))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "MS1 peptide ratio", fill = "Experiment") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 2)
dev.off()

pdf("MS1.ratio.log1p_cell.pdf",
    width = 8,
    height = 8)
ggplot(ptm.ratio.ms1, aes(x = as.factor(run_id), y = ratio.log1p, fill = as.factor(experiment))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "MS1 peptide ratio", fill = "Experiment") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 2)
dev.off()
```

### MS2 ratio
```{r}
setwd("/Users/ronaldcutler/Dropbox (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/6-technical-variability/auto/normalization")

ptm.ratio.ms2 <- calculate_ptm_ratio(obj.filter, assay = "MS2")

pdf("MS2.ratio_cell.pdf",
    width = 8,
    height = 8)
ggplot(ptm.ratio.ms2, aes(x = as.factor(run_id), y = ratio, fill = as.factor(experiment))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "MS2 peptide ratio", fill = "Experiment") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 2)
dev.off()

pdf("MS2.ratio.log1p_cell.pdf",
    width = 8,
    height = 8)
ggplot(ptm.ratio.ms2, aes(x = as.factor(run_id), y = ratio.log1p, fill = as.factor(experiment))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "MS2 peptide ratio", fill = "Experiment") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 2)
dev.off()
```

### Single PTM ratios
- summing percentages of same types of mods on same amino acid across peptides
```{r}
sptm.ratio.ms1 <- calculate_single_ptm_ratio(ptm.ratio.ms1, input = "long")
sptm.ratio.ms1.log1p <- log1p(sptm.ratio.ms1)
```

### Global PTM ratios
- Summing percentages of MS1
- Improvement: Use raw MS1 values to calculate new percentages
```{r}
global.ratio.ms1 <- calculate_global_ptm_ratio(sptm.ratio.ms1)
global.ratio.ms1.log1p <- log1p(global.ratio.ms1)
```

### Summarized H4 PTM ratios
- Summing percentages of MS1 for each combo of peptides: mono, di, tri, tetra
- Improvement: Use raw MS1 values to calculate new percentages
```{r}
h4.ac.ratio.ms1 <- calculate_h4_ac_summary_ratio(ptm.ratio.ms1, input = "long")
h4.ac.ratio.ms1.log1p <- log1p(h4.ac.ratio.ms1)
```

### Create new multi assay experiment
- Must create new one since number of peptides is different than previous object
- Using multi assay experiment to hold the summarized ratios
- IMPROVEMENT: add sample map
```{r}
# create summarized experiment from ratios
obj.filter.ratio <- load_ratio_summarized_experiment(ptm.ratio.ms1, 
                                                     ptm.ratio.ms2, 
                                                     obj.filter)

# remove the NA probes
obj.filter.ratio <- obj.filter.ratio[complete.cases(assay(obj.filter.ratio, "MS1.ratio")),]

# create sample map for adding in other matrices
# map <- data.frame(
#     primary = colnames(obj.filter.ratio),
#     colnames = colnames(obj.filter.ratio),
#     stringsAsFactors = FALSE)
# 
# maplist <- list(ptm.ratio = map, 
#                 sptm.ratio = map,
#                 global.ratio = map,
#                 h4.ac.ratio = map)
# 
# sampMap <- listToMap(maplist)

# create multi assay experiment that contains multiple summarized experiments 
obj.filter.ratio.multi <- MultiAssayExperiment(experiments = ExperimentList(list(ptm.ratio = obj.filter.ratio,
                                                                sptm.ratio = SummarizedExperiment(list(MS1.ratio = sptm.ratio.ms1,
                                                                                                       MS1.ratio.log1p = sptm.ratio.ms1.log1p)),
                                                                global.ratio = SummarizedExperiment(list(MS1.ratio = global.ratio.ms1,
                                                                                                         MS1.ratio.log1p = global.ratio.ms1.log1p)),
                                                                h4.ac.ratio = SummarizedExperiment(list(MS1.ratio = h4.ac.ratio.ms1,
                                                                                                        MS1.ratio.log1p = h4.ac.ratio.ms1.log1p)))),
                                               colData = colData(obj.filter.ratio))
```

### Visualize

#### MS1 ratio
```{r}
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/normalization")

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              experiment = obj.filter.ratio.multi$experiment,
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              condition = obj.filter.ratio.multi$condition,
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.log1p_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["ptm.ratio"]], "MS1.ratio.log1p"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "MS1 Peptide Ratio"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
p <- pca(assay(experiments(obj.filter.ratio.multi)[["ptm.ratio"]], "MS1.ratio.log1p"),
         metadata = colData(obj.filter.ratio.multi),
         center = TRUE, 
         scale = TRUE)

pdf("MS1.ratio.log1p_screeplot.pdf",
    width = 5,
    height = 5)
screeplot(p,
          components = getComponents(p)[1:10])
dev.off()

pdf("MS1.ratio.log1p_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "run_id", "multiplier"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS1.ratio.log1p_replicate_pca.pdf",
    width = 5,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'top',
       hline = 0, 
       vline = 0,
       lab = NULL) +
  labs(color = "Replicate",
       shape = "Multiplier") +
  theme_Publication() +
  theme(legend.box="vertical", 
        legend.margin=margin())
dev.off()
```

#### MS2 ratio
```{r}
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/normalization")

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio$replicate),
                              experiment = obj.filter.ratio$experiment,
                              cell_number = as.factor(obj.filter.ratio$multiplier),
                              condition = obj.filter.ratio$condition,
                              run_id = obj.filter.ratio$run_id)

pdf("MS2.ratio.log1p_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["ptm.ratio"]], "MS2.ratio.log1p"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "MS2 Peptide Ratio"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
p <- pca(assay(experiments(obj.filter.ratio.multi)[["ptm.ratio"]], "MS2.ratio.log1p"),
         metadata = colData(obj.filter.ratio),
         center = TRUE, 
         scale = TRUE)

pdf("MS2.ratio.log1p_screeplot.pdf",
    width = 5,
    height = 5)
screeplot(p,
          components = getComponents(p)[1:10])
dev.off()

pdf("MS2.ratio.log1p_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "run_id", "multiplier"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS2.ratio.log1p_replicate_pca.pdf",
    width = 5,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'top',
       hline = 0, 
       vline = 0,
       lab = NULL) +
  labs(color = "Replicate",
       shape = "Multiplier") +
  theme_Publication() +
  theme(legend.box="vertical", 
        legend.margin=margin())
dev.off()
```

#### Single PTM ratio
```{r}
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/normalization")

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              experiment = obj.filter.ratio.multi$experiment,
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              condition = obj.filter.ratio.multi$condition,
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.single_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["sptm.ratio"]], "MS1.ratio"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

pdf("MS1.ratio.log1p.single_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["sptm.ratio"]], "MS1.ratio.log1p"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()
```

#### Global PTM ratio
```{r}
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/normalization")

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              experiment = obj.filter.ratio.multi$experiment,
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              condition = obj.filter.ratio.multi$condition,
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.global_heatmap.pdf",
    width = 10,
    height = 3)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["global.ratio"]], "MS1.ratio"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

pdf("MS1.ratio.log1p.global_heatmap.pdf",
    width = 10,
    height = 3)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["global.ratio"]], "MS1.ratio.log1p"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()
```

#### Summarized H4 PTM ratio
```{r}
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/normalization")

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              experiment = obj.filter.ratio.multi$experiment,
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              condition = obj.filter.ratio.multi$condition,
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.h4_heatmap.pdf",
    width = 10,
    height = 3)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["h4.ac.ratio"]], "MS1.ratio"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

pdf("MS1.ratio.log1p.h4_heatmap.pdf",
    width = 10,
    height = 3)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["h4.ac.ratio"]], "MS1.ratio.log1p"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()
```

### Save object
```{r}
setwd("~/single-cell-histone-ptm/6-technical-variability/auto")

saveRDS(obj.filter.ratio.multi, "obj.filter.ratio.multi.RDS")
```

### Output tables
```{r}
dir.create("~/single-cell-histone-ptm/6-technical-variability/auto/tables")
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/tables")

write.csv(assay(obj.filter.ratio.multi[["ptm.ratio"]], "RT"), "RT.csv")

# untransformed
write.csv(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio"), "MS1.ratio.csv")
write.csv(assay(obj.filter.ratio.multi[["sptm.ratio"]], "MS1.ratio"), "MS1.ratio.single.csv")
write.csv(assay(obj.filter.ratio.multi[["global.ratio"]], "MS1.ratio"), "MS1.ratio.global.csv")
write.csv(assay(obj.filter.ratio.multi[["h4.ac.ratio"]], "MS1.ratio"), "MS1.ratio.h4.csv")

# transformed
write.csv(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio.log1p"), "MS1.ratio.log1p.csv")
write.csv(assay(obj.filter.ratio.multi[["sptm.ratio"]], "MS1.ratio.log1p"), "MS1.ratio.log1p.single.csv")
write.csv(assay(obj.filter.ratio.multi[["global.ratio"]], "MS1.ratio.log1p"), "MS1.ratio.log1p.global.csv")
write.csv(assay(obj.filter.ratio.multi[["h4.ac.ratio"]], "MS1.ratio.log1p"), "MS1.ratio.log1p.h4.csv")
```

# Batch correction

### MS1
```{r}
dir.create("~/single-cell-histone-ptm/6-technical-variability/auto/batch-corrected")
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/batch-corrected")

assays(obj.filter.ratio.multi[["ptm.ratio"]], withDimnames=FALSE)[["MS1.ratio.log1p.batchCorrect"]] <- 
  removeBatchEffect(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio.log1p"),
                    batch = obj.filter.ratio.multi$replicate)

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              run_id = obj.filter.ratio.multi$run_id)
row_ha = rowAnnotation(charge = anno_barplot(rowData(obj.filter.ratio.multi[["ptm.ratio"]])$Precursor.Charge))

pdf("MS1.ratio.log1p.batchCorrect_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio.log1p.batchCorrect"),
        top_annotation = column_ha,
        right_annotation = row_ha,
        heatmap_legend_param = list(title = "Normalized Peptide Ratio"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
p <- pca(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio.log1p.batchCorrect"),
         metadata = colData(obj.filter.ratio.multi),
         center = TRUE, 
         scale = TRUE)

pdf("MS1.ratio.log1p.batchCorrect_screeplot.pdf",
    width = 5,
    height = 5)
screeplot(p,
          components = getComponents(p)[1:10])
dev.off()

pdf("MS1.ratio.log1p.batchCorrect_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "date", "run_id", "multiplier"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS1.ratio.log1p.batchCorrect_replicate_pca.pdf",
    width = 4,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'top',
       hline = 0, 
       vline = 0,
       lab = NULL) +
  labs(color = "Replicate",
       shape = "Multiplier") +
  theme_Publication() +
  theme(legend.box="vertical", 
        legend.margin=margin())
dev.off()

pdf("MS1.ratio.log1p.batchCorrect_replicate_pca_pairs.pdf",
    width = 5,
    height = 5)
pairsplot(p,
          components = getComponents(p, seq_len(3)),
          colby = "replicate", 
          shape = "multiplier",
          hline = 0, 
          vline = 0,
          lab = NULL)
dev.off()
```

### MS2
```{r}
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/batch-corrected")

assays(obj.filter.ratio.multi[["ptm.ratio"]], withDimnames=FALSE)[["MS2.ratio.log1p.batchCorrect"]] <- 
  removeBatchEffect(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS2.ratio.log1p"),
                    batch = obj.filter.ratio.multi$replicate)

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              run_id = obj.filter.ratio.multi$run_id)
row_ha = rowAnnotation(charge = anno_barplot(rowData(obj.filter.ratio.multi[["ptm.ratio"]])$Precursor.Charge))

pdf("MS2.ratio.log1p.batchCorrect_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS2.ratio.log1p.batchCorrect"),
        top_annotation = column_ha,
        right_annotation = row_ha,
        heatmap_legend_param = list(title = "Normalized Peptide Ratio"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
p <- pca(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS2.ratio.log1p.batchCorrect"),
         metadata = colData(obj.filter.ratio.multi),
         center = TRUE, 
         scale = TRUE)

pdf("MS2.ratio.log1p.batchCorrect_screeplot.pdf",
    width = 5,
    height = 5)
screeplot(p,
          components = getComponents(p)[1:10])
dev.off()

pdf("MS2.ratio.log1p.batchCorrect_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "date", "run_id", "multiplier"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS2.ratio.log1p.batchCorrect_replicate_pca.pdf",
    width = 5,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'top',
       hline = 0, 
       vline = 0,
       lab = NULL) +
  labs(color = "Replicate",
       shape = "Multiplier") +
  theme_Publication() +
  theme(legend.box="vertical", 
        legend.margin=margin())
dev.off()
```

### Single PTM ratio
- Recalculate using new batch corrected ms1 ratios
```{r}
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/batch-corrected")

assays(obj.filter.ratio.multi[["sptm.ratio"]], withDimnames=FALSE)[["MS1.ratio.log1p.batchCorrect"]] <- 
  removeBatchEffect(assay(obj.filter.ratio.multi[["sptm.ratio"]], "MS1.ratio.log1p"),
                    batch = obj.filter.ratio.multi$replicate)

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.log1p.batchCorrect.single_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["sptm.ratio"]], "MS1.ratio.log1p.batchCorrect"),
        top_annotation = column_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()
```

### Global PTM ratio
- Recalculate using new batch corrected ms1 ratios
```{r}
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/batch-corrected")

assays(obj.filter.ratio.multi[["global.ratio"]], withDimnames=FALSE)[["MS1.ratio.log1p.batchCorrect"]] <- 
  removeBatchEffect(assay(obj.filter.ratio.multi[["global.ratio"]], "MS1.ratio.log1p"),
                    batch = obj.filter.ratio.multi$replicate)

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.log1p.batchCorrect.global_heatmap.pdf",
    width = 10,
    height = 3)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["global.ratio"]], "MS1.ratio.log1p.batchCorrect"),
        top_annotation = column_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()
```

### Summarized H4 PTM ratio
```{r}
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/batch-corrected")

assays(obj.filter.ratio.multi[["h4.ac.ratio"]], withDimnames=FALSE)[["MS1.ratio.log1p.batchCorrect"]] <- 
  removeBatchEffect(assay(obj.filter.ratio.multi[["h4.ac.ratio"]], "MS1.ratio.log1p"),
                    batch = obj.filter.ratio.multi$replicate)

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.log1p.batchCorrect.h4_heatmap.pdf",
    width = 10,
    height = 3)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["h4.ac.ratio"]], "MS1.ratio.log1p.batchCorrect"),
        top_annotation = column_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()
```

### Save object
```{r}
setwd("~/single-cell-histone-ptm/6-technical-variability/auto")

saveRDS(obj.filter.ratio.multi, "obj.filter.ratio.multi.RDS")
```

### Output tables
```{r}
dir.create("~/single-cell-histone-ptm/6-technical-variability/auto/tables")
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/tables")

write.csv(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio.log1p.batchCorrect"), "MS1.ratio.log1p.batchCorrect.csv")
write.csv(assay(obj.filter.ratio.multi[["sptm.ratio"]], "MS1.ratio.log1p.batchCorrect"), "MS1.ratio.log1p.batchCorrect.csv")
write.csv(assay(obj.filter.ratio.multi[["global.ratio"]], "MS1.ratio.log1p.batchCorrect"), "MS1.ratio.log1p.batchCorrect.csv")
write.csv(assay(obj.filter.ratio.multi[["h4.ac.ratio"]], "MS1.ratio.log1p.batchCorrect"), "MS1.ratio.log1p.batchCorrect.csv")
```

# Unnormalized analysis

## Consistency within replicate (plate)
- Not using batch corrected as these produce abnormal results

### MS1
```{r}
dir.create("~/single-cell-histone-ptm/6-technical-variability/auto/within_replicate/unnormalized")
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/within_replicate/unnormalized")

# merge with meta data
df <- assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio") %>% 
  as.data.frame() %>%
  rownames_to_column("ptm") %>%
  pivot_longer(
    cols = -ptm, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj.filter.ratio)), by.x = "variable", by.y = "row.names")

# get CV for each ptm, replicate, standard amount
df.cv <- df %>%
  group_by(ptm, replicate, multiplier) %>%
  summarize(CV = sd(value, na.rm = TRUE)/mean(value, na.rm = TRUE))

write.csv(df.cv, "MS1_CV.csv", row.names = FALSE)

# plot by replicate, standard amount
pdf("MS1_CV_replicate.pdf",
    width = 5,
    height = 5)
ggplot(subset(df.cv, multiplier %in% c(1,2,4,8)), aes(x = as.factor(multiplier), y = CV, fill = as.factor(replicate))) +
  geom_violin(scale = "width",
              width = 0.75,
              trim = TRUE,
              position = position_dodge(width = 0.8)) +
  geom_boxplot(width = 0.25,
               position = position_dodge(width = 0.8),
               outlier.shape = NA) + 
  theme_Publication() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = c(seq(0, 1.5, by = 0.25))) +
  labs(title = "", x = "Histone Standard (pg)", y = "Coefficient of Variation", fill = "Replicate", subtitle = "Within Replicate Batch") +
  scale_x_discrete(labels = c("10", "20", "40", "80"))
dev.off()

pdf("MS1_CV_replicate_transparent.pdf",
    width = 5,
    height = 5)
ggplot(subset(df.cv, multiplier %in% c(1,2,4,8)), aes(x = as.factor(multiplier), y = CV, fill = as.factor(replicate))) +
  geom_violin(scale = "width",
              width = 0.75,
              trim = TRUE,
              position = position_dodge(width = 0.8)) +
  geom_boxplot(width = 0.25,
               position = position_dodge(width = 0.8),
               outlier.shape = NA) + 
  theme_Publication() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = c(seq(0, 1.5, by = 0.25))) +
  labs(title = "", x = "Histone Standard (pg)", y = "Coefficient of Variation", fill = "Replicate") +
  scale_x_discrete(labels = c("10", "20", "40", "80")) +
  theme(plot.background = element_rect(fill = "transparent", colour = NA), # transparent background
        panel.background = element_rect(fill = "transparent", colour = NA), # transparent panel
        legend.background = element_rect(fill = "transparent", colour = NA), # transparent legend
        legend.key = element_rect(fill = "transparent", colour = NA)) # transparent legend keys
dev.off()

# plot by replicate, standard amount, ptm
pdf("MS1_CV_ptm.pdf",
    width = 25,
    height = 25)
ggplot(subset(df.cv, multiplier %in% c(1,2,4,8)), aes(x = as.factor(multiplier), y = CV, fill = as.factor(replicate))) +
  geom_bar(stat = "identity", position=position_dodge()) +
  theme_Publication(base_size = 12) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  guides(fill = guide_legend(override.aes = list(shape = NA))) +
  labs(title = "", x = "Histone Standard (pg*10)", y = "Coefficient of Variation", fill = "Replicate", subtitle = "Within Replicate Batch") +
  facet_wrap(.~ptm, scales = "free", labeller = labeller(ptm = label_wrap_gen(20)))
dev.off()
```

## Consistency across plates

### MS1
- Get mean intensity for each ptm in each plate for each standard amount and then get CV across plates
```{r}
dir.create("~/single-cell-histone-ptm/6-technical-variability/auto/across_replicate/unnormalized")
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/across_replicate/unnormalized")

# merge with meta data
df <- assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio") %>% 
  as.data.frame() %>%
  rownames_to_column("ptm") %>%
  pivot_longer(
    cols = -ptm, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj.filter.ratio)), by.x = "variable", by.y = "row.names")

# summarize for each ptm in each replicate
df.cv <- df %>%
  group_by(ptm, replicate, multiplier) %>%
  summarize(mean = mean(value, na.rm = TRUE)) %>%
  group_by(ptm, multiplier) %>%
  summarize(CV = sd(mean, na.rm = TRUE)/mean(mean, na.rm = TRUE))

write.csv(df.cv, "MS1_CV.csv", row.names = FALSE)

# plot by standard amount
pdf("MS1_CV_replicate.pdf",
    width = 5,
    height = 5)
ggplot(subset(df.cv, multiplier %in% c(1,2,4,8)), aes(x = as.factor(multiplier), y = CV)) +
  geom_violin(scale = "width",
              width = 0.75,
              trim = TRUE,
              position = position_dodge(width = 0.8)) +
  geom_boxplot(width = 0.25,
               position = position_dodge(width = 0.8),
               outlier.shape = NA) + 
  theme_Publication() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = c(seq(0, 1.5, by = 0.25))) +
  labs(title = "", x = "Histone Standard (pg)", y = "Coefficient of Variation", fill = "Replicate", subtitle = "Across Replicate Batches") +
  scale_x_discrete(labels = c("10", "20", "40", "80"))
dev.off()

# plot by standard amount, ptm
pdf("MS1_CV_ptm.pdf",
    width = 25,
    height = 25)
ggplot(subset(df.cv, multiplier %in% c(1,2,4,8)), aes(x = as.factor(multiplier), y = CV)) +
  geom_bar(stat = "identity", position=position_dodge()) +
  theme_Publication(base_size = 12) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  guides(fill = guide_legend(override.aes = list(shape = NA))) +
  labs(title = "", x = "Histone Standard (pg*10)", y = "Coefficient of Variation") +
  facet_wrap(.~ptm, scales = "free", labeller = labeller(ptm = label_wrap_gen(20)))
dev.off()
```

# Normalized analysis

## Consistency within replicate (plate)

### MS1
```{r}
dir.create("~/single-cell-histone-ptm/6-technical-variability/auto/within_replicate/normalized")
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/within_replicate/normalized")

# merge with meta data
df <- assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio.log1p.batchCorrect") %>% 
  as.data.frame() %>%
  rownames_to_column("ptm") %>%
  pivot_longer(
    cols = -ptm, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj.filter.ratio)), by.x = "variable", by.y = "row.names")

# get CV for each ptm, replicate, standard amount
df.cv <- df %>%
  group_by(ptm, replicate, multiplier) %>%
  summarize(CV = sd(value, na.rm = TRUE)/mean(value, na.rm = TRUE)) %>%
  filter(CV > 0)

write.csv(df.cv, "MS1.ratio.log1p.batchCorrect_CV.csv", row.names = FALSE)

# plot by replicate, standard amount
pdf("MS1.ratio.log1p_CV_replicate.pdf",
    width = 5,
    height = 5)
ggplot(subset(df.cv, multiplier %in% c(1,2,4,8)), aes(x = as.factor(multiplier), y = CV, fill = as.factor(replicate))) +
  geom_violin(scale = "width",
              width = 0.75,
              trim = TRUE,
              position = position_dodge(width = 0.8)) +
  geom_boxplot(width = 0.25,
               position = position_dodge(width = 0.8),
               outlier.shape = NA) + 
  theme_Publication() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = c(seq(0, 1.5, by = 0.25))) +
  labs(title = "", x = "Histone Standard (pg)", y = "Coefficient of Variation", fill = "Replicate", subtitle = "Within Replicate Batch") +
  scale_x_discrete(labels = c("10", "20", "40", "80"))
dev.off()

pdf("MS1.ratio.log1p_CV_replicate_transparent.pdf",
    width = 5,
    height = 5)
ggplot(subset(df.cv, multiplier %in% c(1,2,4,8)), aes(x = as.factor(multiplier), y = CV, fill = as.factor(replicate))) +
  geom_violin(scale = "width",
              width = 0.75,
              trim = TRUE,
              position = position_dodge(width = 0.8)) +
  geom_boxplot(width = 0.25,
               position = position_dodge(width = 0.8),
               outlier.shape = NA) + 
  theme_Publication() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = c(seq(0, 1.5, by = 0.25))) +
  labs(title = "", x = "Histone Standard (pg)", y = "Coefficient of Variation", fill = "Replicate") +
  scale_x_discrete(labels = c("10", "20", "40", "80")) +
  theme(plot.background = element_rect(fill = "transparent", colour = NA), # transparent background
        panel.background = element_rect(fill = "transparent", colour = NA), # transparent panel
        legend.background = element_rect(fill = "transparent", colour = NA), # transparent legend
        legend.key = element_rect(fill = "transparent", colour = NA)) # transparent legend keys
dev.off()

# plot by replicate, standard amount, ptm
pdf("MS1.ratio.log1p_CV_ptm.pdf",
    width = 25,
    height = 25)
ggplot(subset(df.cv, multiplier %in% c(1,2,4,8)), aes(x = as.factor(multiplier), y = CV, fill = as.factor(replicate))) +
  geom_bar(stat = "identity", position=position_dodge()) +
  theme_Publication(base_size = 12) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  guides(fill = guide_legend(override.aes = list(shape = NA))) +
  labs(title = "", x = "Histone Standard (pg*10)", y = "Coefficient of Variation", fill = "Replicate", subtitle = "Within Replicate Batch") +
  facet_wrap(.~ptm, scales = "free", labeller = labeller(ptm = label_wrap_gen(20)))
dev.off()
```

## Consistency across plates

### MS1
- Get mean intensity for each ptm in each plate for each standard amount and then get CV across plates
```{r}
dir.create("~/single-cell-histone-ptm/6-technical-variability/auto/across_replicate/normalized")
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/across_replicate/normalized")

# merge with meta data
df <- assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio.log1p.batchCorrect") %>% 
  as.data.frame() %>%
  rownames_to_column("ptm") %>%
  pivot_longer(
    cols = -ptm, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj.filter.ratio)), by.x = "variable", by.y = "row.names")

# summarize for each ptm in each replicate
df.cv <- df %>%
  group_by(ptm, replicate, multiplier) %>%
  summarize(mean = mean(value, na.rm = TRUE)) %>%
  group_by(ptm, multiplier) %>%
  summarize(CV = sd(mean, na.rm = TRUE)/mean(mean, na.rm = TRUE))

write.csv(df.cv, "MS1_CV.csv", row.names = FALSE)

# plot by standard amount
pdf("MS1.ratio.log1p.batchCorrect_CV_replicate.pdf",
    width = 5,
    height = 5)
ggplot(subset(df.cv, multiplier %in% c(1,2,4,8)), aes(x = as.factor(multiplier), y = CV)) +
  geom_violin(scale = "width",
              width = 0.75,
              trim = TRUE,
              position = position_dodge(width = 0.8)) +
  geom_boxplot(width = 0.25,
               position = position_dodge(width = 0.8),
               outlier.shape = NA) + 
  theme_Publication() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = c(seq(0, 1.5, by = 0.25))) +
  labs(title = "", x = "Histone Standard (pg)", y = "Coefficient of Variation", fill = "Replicate", subtitle = "Across Replicate Batches") +
  scale_x_discrete(labels = c("10", "20", "40", "80"))
dev.off()

# plot by standard amount, ptm
pdf("MS1.ratio.log1p.batchCorrect_CV_ptm.pdf",
    width = 25,
    height = 25)
ggplot(subset(df.cv, multiplier %in% c(1,2,4,8)), aes(x = as.factor(multiplier), y = CV)) +
  geom_bar(stat = "identity", position=position_dodge()) +
  theme_Publication(base_size = 12) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  guides(fill = guide_legend(override.aes = list(shape = NA))) +
  labs(title = "", x = "Histone Standard (pg*10)", y = "Coefficient of Variation") +
  facet_wrap(.~ptm, scales = "free", labeller = labeller(ptm = label_wrap_gen(20)))
dev.off()
```

#### Peptide CV
- Only using 10 pg sample to compare with single cells
- Applying batch correction
- Only plotting modified peptides
```{r}
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/across_replicate/normalized")

# subset 10pg samples
obj.filter.ratio.multi.10pg <- obj.filter.ratio.multi[["ptm.ratio"]][,obj.filter.ratio.multi$multiplier == 1]

# batch correction
assays(obj.filter.ratio.multi.10pg, withDimnames=FALSE)[["MS1.ratio.log1p.batchCorrect"]] <- 
  removeBatchEffect(assay(obj.filter.ratio.multi.10pg, "MS1.ratio.log1p"),
                    batch = obj.filter.ratio.multi.10pg$replicate)

# filter out unmodified
peptides <- rownames(obj.filter.ratio.multi.10pg)
peptides <- peptides[!(grepl("\\[un\\]", peptides) & !grepl("\\[(me|ac|me2|me3|su|hib)\\]", peptides))]
obj.filter.ratio.multi.10pg.no_unmod <- obj.filter.ratio.multi.10pg[rownames(obj.filter.ratio.multi.10pg) %in% peptides,]

# make the histone ptms readable
rownames(obj.filter.ratio.multi.10pg.no_unmod) <- ptm_readable_translation(rownames(obj.filter.ratio.multi.10pg.no_unmod))

# get cv
df <- assay(obj.filter.ratio.multi.10pg.no_unmod, "MS1.ratio.log1p.batchCorrect") %>%
  as.data.frame() %>%
  rownames_to_column("ptm") %>%
  pivot_longer(
    cols = -ptm, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  group_by(ptm) %>%
  summarize(mean = mean(value, na.rm = TRUE),
            mean.log2 = log2(mean),
            cv = sd(value, na.rm = TRUE)/mean,
            cv.squared = cv^2) %>%
  merge(as.data.frame(rowData(obj.filter.ratio.multi.10pg.no_unmod)), by.x = "ptm", by.y = "row.names")
df$Protein.Name <- protein_readable_translation(df$Protein.Name)

# plot cv
df.plot <- df[order(df$cv, decreasing = TRUE),] # order
df.plot$ptm <- factor(df.plot$ptm,
                      levels = rev(df.plot$ptm))

pdf("MS1.ratio.log1p.batchCorrect_CV_peptide.pdf",
    width = 7,
    height = 7)
ggplot(df.plot, aes(x=ptm, y=cv, fill=Protein.Name)) +
  geom_bar(stat="identity", width=0.95, position = position_dodge(width=1)) +
  geom_text(aes(label=ptm), vjust=0.5, hjust = -0.05, angle=0, position=position_dodge(width=1), size = 3) +
  coord_flip() +
  theme_Publication() +
  scale_fill_manual(values = protein_colors) +
  labs(y = "Coefficient of Variation",
       x = "Histone PTM",
       fill = "Protein") +
  theme(legend.position = "right",
      legend.direction = "vertical",
      legend.margin=margin(),
      axis.text.y=element_blank(),
      axis.ticks.y=element_blank())  +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                     breaks = c(seq(0, 1.5, by = 0.25)),
                     limits = c(0, 1))
dev.off()

pdf("MS1.ratio.log1p.batchCorrect_CV_peptide_top_20.pdf",
    width = 6,
    height = 5)
ggplot(df.plot[1:20,], aes(x=ptm, y=cv, fill=Protein.Name)) +
  geom_bar(stat="identity", width=0.95, position = position_dodge(width=1)) +
  geom_text(aes(label=ptm), vjust=0.5, hjust = -0.05, angle=0, position=position_dodge(width=1), size = 3) +
  coord_flip() +
  theme_Publication() +
  scale_fill_manual(values = protein_colors) +
  labs(y = "Coefficient of Variation",
       x = "Histone PTM",
       fill = "Protein") +
  theme(legend.position = "right",
      legend.direction = "vertical",
      legend.margin=margin(),
      axis.text.y=element_blank(),
      axis.ticks.y=element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                     breaks = c(seq(0, 1.5, by = 0.25)),
                     limits = c(0, 1))
dev.off()
```

##### Save
```{r}
setwd("/Users/ronaldcutler/Dropbox (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/6-technical-variability/auto")

saveRDS(obj.filter.ratio.multi.10pg, "obj.filter.ratio.multi.10pg.RDS")
```

# Bulk analysis

## Histone standards
- get CV of 10 pg sample within each batch and then average across batches
```{r}
dir.create("~/single-cell-histone-ptm/6-technical-variability/auto/bulk")
setwd("~/single-cell-histone-ptm/6-technical-variability/auto/bulk")

sc.cv <- assay(obj.filter.ratio.multi.10pg, "MS1.ratio.log1p.batchCorrect") %>%
  as.data.frame() %>%
  rownames_to_column("ptm") %>%
  pivot_longer(
    cols = -ptm, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj.filter.ratio.multi.10pg)), by.x = "variable", by.y = "row.names") %>%
  filter(multiplier == 1) %>%
  group_by(ptm, replicate) %>%
  summarize(cv = sd(value, na.rm = TRUE)/mean(value, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(ptm) %>%
  summarize(cv.mean = mean(cv, na.rm = TRUE))
```

## DIA low res study
```{r}
# filter based on peptides in histone standard
dialowres.filter <- subset(dialowres, Peptide.Note.New %in% rownames(obj.filter.ratio.multi.10pg))

dialowres.filter$cv <- apply(dialowres.filter[,grepl("hela", colnames(dialowres.filter))], 1, calculate_cv)

sc.cv.dialowres.filter <- sc.cv %>% 
  filter(ptm %in% c(dialowres.filter$Peptide.Note.New))

df <- data.frame("peptide" = sc.cv.dialowres.filter$ptm,
                 "10 pg histone standard" = sc.cv.dialowres.filter$cv.mean,
                 "Bulk" = dialowres.filter$cv)

write.csv(df, "MS1_cv_dia_low_res.csv",
          row.names = FALSE)

pdf("MS1_cv_dia_low_res.pdf",
    width = 5,
    height = 5)
ggplot(melt(df), aes(x = variable, y = value, fill = variable)) +
  geom_violin(scale = "width",
              width = 0.75,
              trim = TRUE,
              position = position_dodge(width = 0.8)) +
  geom_boxplot(width = 0.25,
               position = position_dodge(width = 0.8),
               outlier.shape = NA) +   
  theme_Publication() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = c(seq(0, 1.5, by = 0.25)), limits = c(0, 1)) +
  labs(y = "Coefficient of Variation", fill = "Studies", subtitle = "Sidoli et al., 2015 A") +
  scale_x_discrete(labels = c("Histone Standard\n10 pg", "HeLa")) +
  scale_fill_manual(values = c("forestgreen",
                               brewer.pal(10, "Purples")[3])) +
theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.y.right = element_blank(),    # Remove text on the right y-axis
        axis.ticks.y.right = element_blank(),  # Remove ticks on the right y-axis
        axis.line.y.right = element_blank())   # Remove line on the right y-axis
dev.off()
```

## Bottom up study
```{r}
# filter based on peptides in histone standard
bottomup.filter <- subset(bottomup, Peptide.Note.New %in% rownames(obj.filter.ratio.multi.10pg))

bottomup.filter$cv <- apply(bottomup.filter[,grepl("BU", colnames(bottomup.filter))], 1, calculate_cv)

sc.cv.bottomup.filter <- sc.cv %>% 
  filter(ptm %in% c(bottomup.filter$Peptide.Note.New))

df <- data.frame("peptide" = sc.cv.bottomup.filter$ptm,
                 "10 pg histone standard" = sc.cv.bottomup.filter$cv.mean,
                 "Bulk" = bottomup.filter$cv)

write.csv(df, "MS1_cv_bottom_up.csv",
          row.names = FALSE)

pdf("MS1_cv_bottom_up.pdf",
    width = 5,
    height = 5)
ggplot(melt(df), aes(x = variable, y = value, fill = variable)) +
  geom_violin(scale = "width",
              width = 0.75,
              trim = TRUE,
              position = position_dodge(width = 0.8)) +
  geom_boxplot(width = 0.25,
               position = position_dodge(width = 0.8),
               outlier.shape = NA) + 
  theme_Publication() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = c(seq(0, 1, by = 0.25)), limits = c(0, 1)) +
  labs(y = "Coefficient of Variation", fill = "Studies", subtitle = "Sidoli et al., 2015 B") +
  scale_x_discrete(labels = c("Histone Standard\n10 pg", "HeLa")) +
  scale_fill_manual(values = c("forestgreen",
                               brewer.pal(10, "Purples")[2])) +
  theme(legend.position = "none",
        axis.title.x = element_blank())
dev.off()
```

## Metabolic labeling study
```{r}
# filter based on peptides in histone standard
met.labeling.filter <- subset(met.labeling, Peptide.Note.New %in% rownames(obj.filter.ratio))

# remove duplicate
met.labeling.filter <- met.labeling.filter[met.labeling.filter$Peptide.Note != "K9me3S10phK14ac",]

met.labeling.filter$cv <- apply(met.labeling.filter[,grepl("tcell", colnames(met.labeling.filter))], 1, calculate_cv)

sc.cv.met.labeling.filter <- sc.cv %>% 
  filter(ptm %in% c(met.labeling.filter$Peptide.Note.New))

df <- data.frame("10 pg histone standard" = sc.cv.met.labeling.filter$cv.mean,
                 "Bulk" = met.labeling.filter$cv)

pdf("MS1_cv_metabolic_labeling_tcells.pdf",
    width = 3.5,
    height = 5)
ggplot(melt(df), aes(x = variable, y = value, fill = variable)) +
  geom_violin(scale = "width",
              width = 0.75,
              trim = TRUE,
              position = position_dodge(width = 0.8)) +
  geom_boxplot(width = 0.25,
               position = position_dodge(width = 0.8),
               outlier.shape = NA) + 
  theme_Publication() +
  scale_y_break(c(1, 1.75)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = c(seq(0, 2, by = 0.25))) +
  labs(y = "Coefficient of Variation", fill = "Studies") +
  scale_x_discrete(labels = c("Histone Standard\n10 pg", "T-cell")) +
  scale_fill_manual(values = c("forestgreen",
                               brewer.pal(10, "Purples")[3])) +
  theme(legend.position = "none",
        axis.title.x = element_blank())
dev.off()
```

## LINCS studies
```{r}
# filter based on peptides in histone standard
sc.cv.lincs.filter <- sc.cv %>% 
  filter(ptm %in% unique(unlist(lapply(lincs, function(x) x$Peptide.Note.New))))

lincs.filter <- lapply(lincs, function(x) x[x$Peptide.Note.New %in% sc.cv.lincs.filter$ptm,])

# calculate cv
lincs.filter <- lapply(lincs.filter, function(df) {
  # Calculate CV for specified columns
  cv_values <- apply(df[, grepl("A0", colnames(df))], 1, calculate_cv)
  
  # Add CV as a new column to the dataframe
  df$cv <- cv_values
  
  # Return the modified dataframe
  return(df)
})

df <- makePaddedDataFrame(c(list(unique(unlist(lapply(lincs.filter, function(x) x$Peptide.Note.New)))),
                            list(sc.cv.lincs.filter$cv.mean),
                            lapply(lincs.filter, function(x) x$cv)))

colnames(df) <- c("10 pg histone standard",
                  sub(".*_Plate\\d+_(.*?)_annotated.*", "\\1", list.files("~/single-cell-histone-ptm/1-data/bulk/malvina",
                                                                           pattern = "LINCS")))

write.csv(df, "MS1_cv_lincs.csv",
          row.names = FALSE)

pdf("MS1_cv_lincs.pdf",
    width = 7,
    height = 6)
ggplot(melt(df), aes(x = variable, y = value, fill = variable)) +
  geom_violin(scale = "width",
              width = 0.75,
              trim = TRUE,
              position = position_dodge(width = 0.8)) +
  geom_boxplot(width = 0.25,
               position = position_dodge(width = 0.8),
               outlier.shape = NA) + 
  theme_Publication() +
  scale_y_break(c(1, 1.75)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = c(seq(0, 2, by = 0.25))) +
  labs(y = "Coefficient of Variation", fill = "Studies", subtitle = "Dele-Oni et al., 2021 (LINCS)") +
  scale_x_discrete(labels = c("Histone Standard\n10 pg", 
                   colnames(df)[-1])) +
  scale_fill_manual(values = c("forestgreen",
                               brewer.pal(11, "Purples")[2:10])) +
  theme(legend.position = "none",
          axis.text.x = element_text(angle = 45, 
                                     hjust = 1),
          axis.title.x = element_blank(),
          axis.text.y.right = element_blank(),    # Remove text on the right y-axis
          axis.ticks.y.right = element_blank(),  # Remove ticks on the right y-axis
          axis.line.y.right = element_blank())   # Remove line on the right y-axis
dev.off()
```