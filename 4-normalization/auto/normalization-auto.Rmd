---
title: "4-normalization: auto"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparation

## Libraries
```{r}
library(SummarizedExperiment)
library(MultiAssayExperiment)
library(PCAtools)
library(ComplexHeatmap)
library(BatchQC)
library(sva)
library(tidyr)
library(dplyr)
library(tibble)
library(purrr)
library(ggplot2)
library(pheatmap)
library(ggpubr)
library(reshape2)
library(viridis)
library(ggrepel)
library(RColorBrewer)
library(stringr)
library(missForest)
library(limma)
```

## Functions
```{r}
source("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/functions.R")
```

## Load data
```{r}
# metadata
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/1-data/single-cell")

coldata <- read.csv("sample-table.csv", 
               header = TRUE,
               stringsAsFactors = TRUE)
# coldata[] <- lapply(coldata, as.factor) # make all vars factors

# skyline output
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/1-data/single-cell/intensities")

# combine all plates
df.1 <- read.csv("240321_Skyline_SC_export_auto1_cells.csv", 
               header = TRUE,
               stringsAsFactors = TRUE,
               na.strings = "#N/A")

df.2 <- read.csv("240321_Skyline_SC_export_auto2_auto4_cells.csv", 
               header = TRUE,
               stringsAsFactors = TRUE,
               na.strings = "#N/A")

df.combine <- rbind(df.1, df.2)

# filter peptides
df.combine.filter <- filter_peptides(df.combine)

# deconvolute isobaric H4 peptides using fragments
df.combine.filter.deconv <- deconvolute_h4(df.combine.filter)

# combine into summarized experiment object
obj <- load_skyline_summarized_experiment(df.combine.filter.deconv, coldata)

# add total MS1 and MS2 to coldata
obj$total.ms1 <- colSums(assay(obj, "MS1"), na.rm = TRUE)
obj$total.ms2 <- colSums(assay(obj, "MS2"), na.rm = TRUE)

# change replicate 4 to 3 to make it easier to read
obj$replicate <- as.character(obj$replicate)
obj$replicate[obj$replicate == 4] <- 3
obj$replicate <- factor(obj$replicate)
```

## Save object
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto")

saveRDS(obj, "obj.RDS")
```

# Unfiltered Data Charecterization

## Types of histone PTMs detected
```{r}
dir.create("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/unfiltered")
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/unfiltered")

# Categorize each peptide
categories <- map_chr(rownames(obj), categorize_peptide)

# Count categories
category_counts <- table(categories)

# Convert to dataframe for ggplot
df <- as.data.frame(category_counts)
  

df$categories <- factor(df$categories, levels = c("Unmodified",
                                                  "Acetylated",
                                                  "Mono-methylated",
                                                  "Di-methylated",
                                                  "Tri-methylated",
                                                  "Hybrid modifications",
                                                  "Other modifications"))

pdf("PTM_types.pdf",
    width = 5,
    height = 5)
ggplot(df, aes(x = "", y = Freq, fill = categories)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0) +
  scale_fill_brewer(palette = "Set1") + # Use a color palette
  theme_void() +
  theme(legend.position = "right",  # Adjust legend position
        legend.title = element_text(size = 12),  # Adjust legend title size
        legend.text = element_text(size = 10)) +  # Adjust legend text size
  labs(fill = "Modification Type") +
  geom_text(aes(label = paste0(round(Freq / sum(Freq) * 100), "%")), 
            position = position_stack(vjust = 0.6), size = 4)# Add percentage labels
dev.off()
```

## Number of samples
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/unfiltered")

# by plate
df <- as.data.frame(table(obj$replicate))
names(df) <- c("Replicate", "Count")
pdf("samples_per_replicate.pdf",
    width = 5,
    height = 5)
ggplot(df, aes(x = Replicate, y = Count)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  theme_Publication() +
  labs(title = "Number of samples per plate", x = "Plate Replicate", y = "Frequency") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1))
dev.off()

# by type
df <- as.data.frame(table(obj$multiplier))
names(df) <- c("Replicate", "Count")
pdf("samples_per_type.pdf",
    width = 5,
    height = 5)
ggplot(df, aes(x = Replicate, y = Count)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  theme_Publication() +
  labs(title = "Number of samples per type", x = "Amount of cells", y = "Frequency")
dev.off()
```

## Peptides detected
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/unfiltered")

# MS1 precursors
data <- assay(obj, "MS1")
data[data == 0] <- NA
df <- as.data.frame(colSums(!is.na(data)))
names(df) <- c("Count")

# number of missing values
sum(is.na(data))/length(!data)*100

pdf("MS1_precursors_per_sample.pdf",
    width = 5,
    height = 5)
ggplot(df, aes(x = Count)) +
  geom_histogram() +
  theme_Publication() +
  labs(title = "Number of precursors\ndetected per sample", x = "# Peptides", y = "Frequency")
dev.off()

pdf("MS1_missing_values.pdf",
    width = 5,
    height = 5)
set.seed(123)
pheatmap(data, 
         annotation_col = as.data.frame(colData(obj)[,c("replicate", "multiplier")]), 
         scale = "none", 
         na_col = "black", 
         show_rownames = FALSE,
         show_colnames = FALSE,
         cluster_rows = FALSE, 
         cluster_cols = FALSE)
dev.off()

# MS2 fragments
# not accurate because don't have data for individual fragments,
# just aggreagate for each peptide
data <- assay(obj, "MS2")
data[data == 0] <- NA
df <- as.data.frame(colSums(!is.na(data)))
names(df) <- c("Count")
pdf("MS2_fragments_per_sample.pdf",
    width = 5,
    height = 5)
ggplot(df, aes(x = Count)) +
  geom_histogram() +
  theme_Publication() +
  labs(title = "Number of fragments\ndetected per sample", x = "# Peptides", y = "Frequency")
dev.off()

pdf("MS2_missing_values.pdf",
    width = 5,
    height = 5)
set.seed(123)
data <- assay(obj, "MS2")
data[data == 0] <- NA
pheatmap(data, 
         annotation_col = as.data.frame(colData(obj)[,c("replicate", "multiplier")]), 
         scale = "none", 
         na_col = "black", 
         show_rownames = FALSE,
         show_colnames = FALSE,
         cluster_rows = FALSE, 
         cluster_cols = FALSE)
dev.off()
```

## Peptide retention times
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/unfiltered")

df <- assay(obj, "RT") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj)), by.x = "variable", by.y = "row.names")

pdf("peptide_retention_times_unflitered_replicate.pdf",
    width = 10,
    height = 10)
ggplot(df, aes(x = id, y = value, color = as.factor(replicate))) +
  geom_jitter(alpha = 0.75) +
  theme_Publication() +
  labs(title = "", x = "Peptide", y = "Retention time (min)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10),
        legend.position = "bottom") +
  scale_color_discrete(name = "Replicate")
dev.off()

pdf("peptide_retention_times_unflitered_type.pdf",
    width = 10,
    height = 10)
ggplot(df, aes(x = id, y = value, color = as.factor(multiplier))) +
  geom_jitter(alpha = 0.75) +
  theme_Publication() +
  labs(title = "", x = "Peptide", y = "Retention time (min)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10),
        legend.position = "bottom") +
  scale_color_discrete(name = "Type")
dev.off()
```

## Intensity distribution

### MS1
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/unfiltered")

# transform
assays(obj)[["MS1.log2"]] <- log2(assay(obj, "MS1") + 1)

# plot by cell
df <- assay(obj, "MS1.log2") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj)), by.x = "variable", by.y = "row.names")

pdf("MS1.log2_distribution_unflitered_cell.pdf",
    width = 8,
    height = 10)
ggplot(df, aes(x = as.factor(run_id), y = value, fill = as.factor(replicate))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "Log2(MS1 intensity)", fill = "Replicate") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 3)
dev.off()

# plot by peptide
pdf("MS1.log2_distribution_unflitered_peptide.pdf",
    width = 15,
    height = 10)
ggplot(df, aes(x = id, y = value)) +
  geom_boxplot() +
  theme_Publication() +
  labs(title = "Cell #", x = "Peptide", y = "Log2(MS1 intensity)", fill = "Replicate") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x")
dev.off()

# heatmap
column_ha = HeatmapAnnotation(Replicate = as.factor(obj$replicate),
                              col = list(Replicate = c("1" = brewer.pal(5, "Set1")[1],
                                                        "2" = brewer.pal(5, "Set1")[2],
                                                        "3" = brewer.pal(5, "Set1")[3]
                                                       )
                                        )
                              )
row_ha = rowAnnotation(charge = anno_barplot(rowData(obj)$Precursor.Charge))
histone_proteins <- str_extract(rowData(obj)$Protein.Name, "(?<=\\|)[^|_]+(?=_HUMAN)")

pdf("MS1.log2_unflitered_heatmap.pdf",
    width = 9,
    height = 11)
Heatmap(assay(obj, "MS1.log2"),
        top_annotation = column_ha,
        right_annotation = row_ha,
        column_title = NULL,
        heatmap_legend_param = list(title = "Log2(MS1 area)"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        split = histone_proteins,
        cluster_column_slices = FALSE,
        cluster_row_slices = FALSE,
        row_names_gp = gpar(fontsize = 10),
        na_col = "yellow")
dev.off() 

column_ha = HeatmapAnnotation(
                              cell_number = as.factor(obj$multiplier),
                              run_id = obj$run_id)


pdf("MS1.log2_unflitered_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(scale(assay(obj, "MS1.log2"), center = FALSE, scale = FALSE),
        top_annotation = column_ha,
        right_annotation = row_ha,
        heatmap_legend_param = list(title = "Log2(MS1 area)"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
df <- colData(obj)
df$multiplier <- factor(df$multiplier)
p <- pca(na.omit(assay(obj, "MS1.log2")),
         metadata = df,
         center = TRUE, 
         scale = TRUE)

screeplot(p)

pdf("MS1.log2_unflitered_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "date", "run_id", "multiplier"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS1.log2_unflitered_replicate_pca.pdf",
    width = 5,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'right',
       hline = 0, 
       vline = 0,
       gridlines.major = FALSE, 
       gridlines.minor = FALSE,
       lab = NULL)
dev.off()
```

### MS2
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/unfiltered")

# transform
assays(obj)[["MS2.log2"]] <- log2(assay(obj, "MS2") + 1)

# plot by cell
df <- assay(obj, "MS2.log2") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj)), by.x = "variable", by.y = "row.names")

pdf("MS2.log2_distribution_unflitered_cell.pdf",
    width = 8,
    height = 10)
ggplot(df, aes(x = as.factor(run_id), y = value, fill = as.factor(replicate))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "Log2(MS2 intensity)", fill = "Replicate") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 3)
dev.off()

# plot by peptide
pdf("MS2.log2_distribution_unflitered_peptide.pdf",
    width = 15,
    height = 10)
ggplot(df, aes(x = id, y = value)) +
  geom_boxplot() +
  theme_Publication() +
  labs(title = "Cell #", x = "Peptide", y = "Log2(MS2 intensity)", fill = "Replicate") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x")
dev.off()

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj$replicate),
                              cell_number = as.factor(obj$multiplier),
                              run_id = obj$run_id)
row_ha = rowAnnotation(charge = anno_barplot(rowData(obj)$Precursor.Charge))

pdf("MS2.log2_unflitered_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(scale(assay(obj, "MS2.log2"), center = FALSE, scale = FALSE),
        top_annotation = column_ha,
        right_annotation = row_ha,
        heatmap_legend_param = list(title = "Log2(MS2 area)"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
df <- colData(obj)
df$multiplier <- factor(df$multiplier)
p <- pca(na.omit(assay(obj, "MS2.log2")),
         metadata = df,
         center = TRUE, 
         scale = TRUE)

screeplot(p)

pdf("MS2.log2_unflitered_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "date", "run_id", "multiplier"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS2.log2_unflitered_replicate_pca.pdf",
    width = 5,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'right',
       hline = 0, 
       vline = 0,
       gridlines.major = FALSE, 
       gridlines.minor = FALSE,
       lab = NULL)
dev.off()
```

### MS1 vs MS2
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/unfiltered")

# by standards
df.1 <- assay(obj, "MS1.log2") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value")


df.2 <- assay(obj, "MS2.log2") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value")

df <- cbind(df.1, df.2$value)
colnames(df) <- c("id", "variable", "ms1", "ms2")
df <- merge(df, as.data.frame(colData(obj)), by.x = "variable", by.y = "row.names")
df$id <- gsub(";", " ", df$id)

# by cell amount
pdf("MS1_vs_MS2_unflitered_type.pdf",
    width = 8,
    height = 8)
ggplot(subset(df, multiplier != "0"), aes(x = ms1, y = ms2, color = as.factor(replicate))) +
  geom_point() +
  stat_smooth(method = "lm") +
  stat_cor() +
  facet_wrap(.~as.factor(multiplier)) +
  labs(title = "", x = "Log2(MS1)", y = "Log2(MS2)") +
  theme_Publication() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_color_discrete(name = "Replicate")
dev.off()

# by peptide for single cells
pdf("MS1_vs_MS2_unflitered_peptide.pdf",
    width = 25,
    height = 25)
ggplot(subset(df, multiplier == "1"), aes(x = ms1, y = ms2, color = as.factor(replicate))) +
  geom_point() +
  stat_smooth(method = "lm") +
  stat_cor() +
  facet_wrap(.~as.factor(multiplier)) +
  labs(title = "HIstone Peptides", x = "Log2(MS1)", y = "Log2(MS2)") +
  theme_Publication(base_size = 12) +
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
  facet_wrap(.~id, scales = "free", labeller = labeller(id = label_wrap_gen(20))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_color_discrete(name = "Replicate")
dev.off()
```

## Background noise

### MS1
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/unfiltered")

# plot single cells vs blanks
df <- assay(obj, "MS1") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj)), by.x = "variable", by.y = "row.names") %>%
  subset(multiplier %in% c(0, 1))
df$id <- gsub(";", " ", df$id)

# summarize
df %>%
  group_by(multiplier) %>%
  summarize(mean = mean(value, na.rm = TRUE))

# peptides separate
  # replicates merged
  pdf("MS1_0cell_vs_1cell_peptide_all.pdf",
      width = 20,
      height = 20)
  ggplot(df, aes(x = as.factor(multiplier), y = value, fill = as.factor(multiplier))) +
    geom_boxplot() +
    geom_jitter(alpha = 0.5) +
    scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Cell #", y = "MS1 Intensity") +
    facet_wrap(~id, scales = "free_y", labeller = labeller(id = label_wrap_gen(20))) +
    theme(legend.position = "none")
  dev.off()
  
  # replicates separated
  pdf("MS1_0cell_vs_1cell_peptide_replicate.pdf",
      width = 20,
      height = 20)
  ggplot(df, aes(x = as.factor(multiplier), y = value)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(alpha = 0.75, aes(color = as.factor(replicate))) +
    scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Cell #", y = "MS1 Intensity", color = "Replicate") +
    facet_wrap(~id, scales = "free_y", labeller = labeller(id = label_wrap_gen(20)))
  dev.off()
  
  # subset representative peptides
  rep_peptides <- c("H2A1B-K13[un] K15[ac]", "H31-K9[me2] K14[un]","H31-K18[un] K23[ac]", "H4-K5[ac] K8[un] K12[ac] K16[un]")
  facet_labels <- c("H2AK15Ac", "H3K9Me2", "H3K23Ac", "H4K5AcK12Ac")
  names(facet_labels) <- rep_peptides
  df.sub <- subset(df, id %in% rep_peptides)
  
  pdf("MS1_0cell_vs_1cell_peptide_representative.pdf",
      width = 7,
      height = 3.5)
  ggplot(df.sub, aes(x = as.factor(multiplier), y = value, fill = as.factor(replicate))) +
    geom_boxplot(outlier.shape = NA) +
    geom_point(alpha = 0.5, size = 0.5, 
               position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75), stat = "identity") +
    scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
    scale_fill_discrete(name = "Replicate") +
    guides(fill = guide_legend(override.aes = list(shape = NA))) +
    labs(title = "", x = "Cell #", y = "MS1 Intensity") +
    facet_wrap(.~id, scales = "free", nrow = 1, labeller = labeller(id = facet_labels)) +
    theme_Publication(base_size = 12) +
    theme(legend.position = "top") +
    guides(color = guide_legend( 
      override.aes=list(shape = 19))) 
  dev.off()

# all peptides
  # replicates merged
  pdf("MS1.log2_0cell_vs_1cell_all.pdf",
      width = 3,
      height = 3)
  ggplot(df, aes(x = value, fill = as.factor(multiplier))) +
    geom_density(alpha = 0.5) +
    scale_x_log10() +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Log2(MS1 intensity)", y = "Density", fill = "Cell #")
  dev.off()
  
  # replicates separated
  pdf("MS1.log2_0cell_vs_1cell_replicate.pdf",
      width = 5,
      height = 3)
  ggplot(df, aes(x = value, fill = as.factor(multiplier))) +
    geom_density(alpha = 0.5) +
    scale_x_log10() +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Log2(MS1 intensity)", y = "Density", fill = "Cell #") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    facet_wrap(~replicate, nrow = 1)
  dev.off()
```

### MS2
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/unfiltered")

# plot single cells vs blanks
df <- assay(obj, "MS2") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj)), by.x = "variable", by.y = "row.names") %>%
  subset(multiplier %in% c(0, 1))
df$id <- gsub(";", " ", df$id)

# summarize
df %>%
  group_by(multiplier) %>%
  summarize(mean = mean(value, na.rm = TRUE))

# peptides separate
  # replicates merged
  pdf("MS2_0cell_vs_1cell_peptide_all.pdf",
      width = 20,
      height = 20)
  ggplot(df, aes(x = as.factor(multiplier), y = value, fill = as.factor(multiplier))) +
    geom_boxplot() +
    geom_jitter(alpha = 0.5) +
    scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Cell #", y = "MS2 Intensity") +
    facet_wrap(~id, scales = "free_y", labeller = labeller(id = label_wrap_gen(20))) +
    theme(legend.position = "none")
  dev.off()
  
  # replicates separated
  pdf("MS2_0cell_vs_1cell_peptide_replicate.pdf",
      width = 20,
      height = 20)
  ggplot(df, aes(x = as.factor(multiplier), y = value)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(alpha = 0.75, aes(color = as.factor(replicate))) +
    scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Cell #", y = "MS2 Intensity", color = "Replicate") +
    facet_wrap(~id, scales = "free_y", labeller = labeller(id = label_wrap_gen(20)))
  dev.off()
  
    # subset representative peptides
  rep_peptides <- c("H2A1B-K13[un] K15[ac]", "H31-K9[me2] K14[un]","H31-K18[un] K23[ac]", "H4-K5[ac] K8[un] K12[ac] K16[un]")
  facet_labels <- c("H2AK15Ac", "H3K9Me2", "H3K23Ac", "H4K5AcK12Ac")
  names(facet_labels) <- rep_peptides
  df.sub <- subset(df, id %in% rep_peptides)
  
  pdf("MS2_0cell_vs_1cell_peptide_representative.pdf",
      width = 7,
      height = 3.5)
  ggplot(df.sub, aes(x = as.factor(multiplier), y = value, fill = as.factor(replicate))) +
    geom_boxplot(outlier.shape = NA) +
    geom_point(alpha = 0.5, size = 0.5, 
               position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75), stat = "identity") +
    scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
    scale_fill_discrete(name = "Replicate") +
    guides(fill = guide_legend(override.aes = list(shape = NA))) +
    labs(title = "", x = "Cell #", y = "MS2 Intensity") +
    facet_wrap(.~id, scales = "free", nrow = 1, labeller = labeller(id = facet_labels)) +
    theme_Publication(base_size = 12) +
    theme(legend.position = "top") +
    guides(color = guide_legend( 
      override.aes=list(shape = 19))) 
  dev.off()


# all peptides
  # replicates merged
  pdf("MS2.log2_0cell_vs_1cell_all.pdf",
      width = 3,
      height = 3)
  ggplot(df, aes(x = value, fill = as.factor(multiplier))) +
    geom_density(alpha = 0.5) +
    scale_x_log10() +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Log2(MS2 intensity)", y = "Density", fill = "Cell #")
  dev.off()
  
  # replicates separated
  pdf("MS2.log2_0cell_vs_1cell_replicate.pdf",
      width = 5,
      height = 3)
  ggplot(df, aes(x = value, fill = as.factor(multiplier))) +
    geom_density(alpha = 0.5) +
    scale_x_log10() +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Log2(MS2 intensity)", y = "Density", fill = "Cell #") +
    facet_wrap(~replicate, nrow = 1) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  dev.off()
```

# Filtering

## Missing peptides
- Filter out peptides not detected in > 50% of single-cells
```{r}
dir.create("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/filtered")
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/filtered")

obj.peptide_filter <- filter_missing_peptides(obj, threshold = 0.5)

saveRDS(obj.peptide_filter, "obj.peptide_filter.RDS")
```


## Background noise removal
- Filter out peptides whose single cell signal is less than 1.5 times greater than the background signal
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/filtered")

obj.background_filter <- filter_background_peptides(obj.peptide_filter, ratio = 1)

saveRDS(obj.background_filter, "obj.background_filter.RDS")
```

### Background noise plots
- Plot now because empty cells will be removed in next filter

#### MS1
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/filtered")

# plot single cells vs blanks
df <- assay(obj.background_filter, "MS1") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj.background_filter)), by.x = "variable", by.y = "row.names") %>%
  subset(multiplier %in% c(0, 1))
df$id <- gsub(";", " ", df$id)

# peptides separate
  # replicates merged
  pdf("MS1_0cell_vs_1cell_peptide_all.pdf",
      width = 20,
      height = 20)
  ggplot(df, aes(x = as.factor(multiplier), y = value, fill = as.factor(multiplier))) +
    geom_boxplot() +
    geom_jitter(alpha = 0.5) +
    scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Cell #", y = "MS1 Intensity") +
    facet_wrap(~id, scales = "free_y", labeller = labeller(id = label_wrap_gen(20))) +
    theme(legend.position = "none")
  dev.off()
  
  # replicates separated
  pdf("MS1_0cell_vs_1cell_peptide_replicate.pdf",
      width = 20,
      height = 20)
  ggplot(df, aes(x = as.factor(multiplier), y = value)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(alpha = 0.75, aes(color = as.factor(replicate))) +
    scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Cell #", y = "MS1 Intensity", color = "Replicate") +
    facet_wrap(~id, scales = "free_y", labeller = labeller(id = label_wrap_gen(20)))
  dev.off()
  
  # subset representative peptides
  rep_peptides <- c("H2A1B-K13[un] K15[ac]", "H31-K9[me2] K14[un]","H31-K18[un] K23[ac]", "H4-K5[ac] K8[un] K12[ac] K16[un]")
  facet_labels <- c("H2AK15Ac", "H3K9Me2", "H3K23Ac", "H4K5AcK12Ac")
  names(facet_labels) <- rep_peptides
  df.sub <- subset(df, id %in% rep_peptides)
  
  pdf("MS1_0cell_vs_1cell_peptide_representative.pdf",
      width = 7,
      height = 3.5)
  ggplot(df.sub, aes(x = as.factor(multiplier), y = value, fill = as.factor(replicate))) +
    geom_boxplot(outlier.shape = NA) +
    geom_point(alpha = 0.5, size = 0.5, 
               position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75), stat = "identity") +
    scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
    scale_fill_discrete(name = "Replicate") +
    guides(fill = guide_legend(override.aes = list(shape = NA))) +
    labs(title = "", x = "Cell #", y = "MS1 Intensity") +
    facet_wrap(.~id, scales = "free", nrow = 1, labeller = labeller(id = facet_labels)) +
    theme_Publication(base_size = 12) +
    theme(legend.position = "top") +
    guides(color = guide_legend( 
      override.aes=list(shape = 19))) 
  dev.off()

# all peptides
  # replicates merged
  pdf("MS1.log2_0cell_vs_1cell_all.pdf",
      width = 3,
      height = 3)
  ggplot(df, aes(x = value, fill = as.factor(multiplier))) +
    geom_density(alpha = 0.5) +
    scale_x_log10() +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Log2(MS1 intensity)", y = "Density", fill = "Cell #")
  dev.off()
  
  # replicates separated
  pdf("MS1.log2_0cell_vs_1cell_replicate.pdf",
      width = 5,
      height = 3)
  ggplot(df, aes(x = value, fill = as.factor(multiplier))) +
    geom_density(alpha = 0.5) +
    scale_x_log10() +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Log2(MS1 intensity)", y = "Density", fill = "Cell #") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    facet_wrap(~replicate, nrow = 1)
  dev.off()
```

#### MS2
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/filtered")

# plot single cells vs blanks
df <- assay(obj.background_filter, "MS2") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj.background_filter)), by.x = "variable", by.y = "row.names") %>%
  subset(multiplier %in% c(0, 1))
df$id <- gsub(";", " ", df$id)

# peptides separate
  # replicates merged
  pdf("MS2_0cell_vs_1cell_peptide_all.pdf",
      width = 20,
      height = 20)
  ggplot(df, aes(x = as.factor(multiplier), y = value, fill = as.factor(multiplier))) +
    geom_boxplot() +
    geom_jitter(alpha = 0.5) +
    scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Cell #", y = "MS2 Intensity") +
    facet_wrap(~id, scales = "free_y", labeller = labeller(id = label_wrap_gen(20))) +
    theme(legend.position = "none")
  dev.off()
  
  # replicates separated
  pdf("MS2_0cell_vs_1cell_peptide_replicate.pdf",
      width = 20,
      height = 20)
  ggplot(df, aes(x = as.factor(multiplier), y = value)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(alpha = 0.75, aes(color = as.factor(replicate))) +
    scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Cell #", y = "MS2 Intensity", color = "Replicate") +
    facet_wrap(~id, scales = "free_y", labeller = labeller(id = label_wrap_gen(20)))
  dev.off()
  
    # subset representative peptides
  rep_peptides <- c("H2A1B-K13[un] K15[ac]", "H31-K9[me2] K14[un]","H31-K18[un] K23[ac]", "H4-K5[ac] K8[un] K12[ac] K16[un]")
  facet_labels <- c("H2AK15Ac", "H3K9Me2", "H3K23Ac", "H4K5AcK12Ac")
  names(facet_labels) <- rep_peptides
  df.sub <- subset(df, id %in% rep_peptides)
  
  pdf("MS2_0cell_vs_1cell_peptide_representative.pdf",
      width = 7,
      height = 3.5)
  ggplot(df.sub, aes(x = as.factor(multiplier), y = value, fill = as.factor(replicate))) +
    geom_boxplot(outlier.shape = NA) +
    geom_point(alpha = 0.5, size = 0.5, 
               position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75), stat = "identity") +
    scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
    scale_fill_discrete(name = "Replicate") +
    guides(fill = guide_legend(override.aes = list(shape = NA))) +
    labs(title = "", x = "Cell #", y = "MS2 Intensity") +
    facet_wrap(.~id, scales = "free", nrow = 1, labeller = labeller(id = facet_labels)) +
    theme_Publication(base_size = 12) +
    theme(legend.position = "top") +
    guides(color = guide_legend( 
      override.aes=list(shape = 19))) 
  dev.off()


# all peptides
  # replicates merged
  pdf("MS2.log2_0cell_vs_1cell_all.pdf",
      width = 3,
      height = 3)
  ggplot(df, aes(x = value, fill = as.factor(multiplier))) +
    geom_density(alpha = 0.5) +
    scale_x_log10() +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Log2(MS2 intensity)", y = "Density", fill = "Cell #")
  dev.off()
  
  # replicates separated
  pdf("MS2.log2_0cell_vs_1cell_replicate.pdf",
      width = 5,
      height = 3)
  ggplot(df, aes(x = value, fill = as.factor(multiplier))) +
    geom_density(alpha = 0.5) +
    scale_x_log10() +
    theme_Publication(base_size = 12) +
    labs(title = "", x = "Log2(MS2 intensity)", y = "Density", fill = "Cell #") +
    facet_wrap(~replicate, nrow = 1) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  dev.off()
```

## Non-linear peptides based on calibration curves with differing amounts of cells
- Go back and plot these curves again now that it is filtered
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/3-calibration-curves/auto/cells/unfiltered")

quant_filter <- read.csv("MS1_calibration_curve_correlations.csv")
 
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/filtered")

obj.quant_filter <- filter_non_linear_peptides(quant_filter, obj.background_filter, correlation = 0.85, p_value = 0.05)

saveRDS(obj.quant_filter, "obj.quant_filter.RDS")
```

## Cell filtering
- Mean intensity of cell is 2SD away from average of all cells. These also cluster with empty cells
- Only use MS1, can try to incorporate MS2 in future?
```{r}
# filter out 2, 4, 8 cells
obj.quant_filter <- obj.quant_filter[,obj.quant_filter$multiplier == 0 |
                                     obj.quant_filter$multiplier == 1 |
                                     obj.quant_filter$multiplier == 100]

# empty should be filtered
obj.cell_filter <- filter_samples(obj.quant_filter, assay = "MS1", dev = 1, filter_low = TRUE, filter_high = FALSE)

# change coldata
obj.cell_filter$multiplier <- factor(obj.cell_filter$multiplier)

# plot which cells were filtered by batch
df <- data.frame(condition = data.frame(table(obj$replicate))[,1],
                 unfiltered = data.frame(table(obj.cell_filter$replicate))[,2],
                 filtered = data.frame(table(obj.cell_filter$replicate))[,2])
df <- melt(df)
pdf("samples_per_batch.pdf",
    width = 5,
    height = 5)
ggplot(df, aes(x = condition, y = value, fill = variable)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  theme_Publication() +
  labs(title = "Samples per batch", x = "Batch", y = "Frequency", fill = "") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1)) +
  scale_fill_brewer()
dev.off()


saveRDS(obj.cell_filter, "obj.cell_filter.RDS")
```

# Filtered Data Charecterization

## Peptide retention times
```{r}
dir.create("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/filtered")
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/filtered")

df <- assay(obj.cell_filter, "RT") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj.cell_filter)), by.x = "variable", by.y = "row.names")

pdf("peptide_retention_times_filtered_replicate.pdf",
    width = 10,
    height = 10)
ggplot(df, aes(x = id, y = value, color = as.factor(replicate))) +
  geom_jitter(alpha = 0.75) +
  theme_Publication() +
  labs(title = "", x = "Peptide", y = "Retention time (min)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10),
        legend.position = "bottom") +
  scale_color_discrete(name = "Replicate")
dev.off()

pdf("peptide_retention_times_filtered_type.pdf",
    width = 10,
    height = 10)
ggplot(df, aes(x = id, y = value, color = as.factor(multiplier))) +
  geom_jitter(alpha = 0.75) +
  theme_Publication() +
  labs(title = "", x = "Peptide", y = "Retention time (min)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10),
        legend.position = "bottom") +
  scale_color_discrete(name = "Type")
dev.off()

# single cells only
pdf("peptide_retention_times_filtered_1cell.pdf",
    width = 6,
    height = 15)
ggplot(subset(df, multiplier == "1"), aes(x = id, y = value, color = as.factor(replicate))) +
  geom_jitter(alpha = 0.75) +
  coord_flip() +
  theme_Publication() +
  labs(title = "", x = "Peptide", y = "Retention time (min)") +
  theme(legend.position = "bottom") +
  scale_color_discrete(name = "Replicate")
dev.off()
```

## Intensity distribution

### MS1
```{r}
# transform
assays(obj.cell_filter)[["MS1.log2"]] <- log2(assay(obj.cell_filter, "MS1") + 1)

# imputation
assays(obj.cell_filter)[["MS1.log2.impute"]] <- missForest(assay(obj.cell_filter, "MS1.log2"))$ximp

# plot by cell
df <- assay(obj.cell_filter, "MS1.log2") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj.cell_filter)), by.x = "variable", by.y = "row.names")

pdf("MS1.log2_distribution_filtered_cell.pdf",
    width = 8,
    height = 10)
ggplot(df, aes(x = as.factor(run_id), y = value, fill = as.factor(replicate))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "Log2(MS1 intensity)", fill = "Replicate") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 3)
dev.off()

# plot by peptide
pdf("MS1.log2_distribution_filtered_peptide.pdf",
    width = 15,
    height = 10)
ggplot(df, aes(x = id, y = value)) +
  geom_boxplot() +
  theme_Publication() +
  labs(title = "Cell #", x = "Peptide", y = "Log2(MS1 intensity)", fill = "Replicate") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x")
dev.off()

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.cell_filter$replicate),
                              cell_number = as.factor(obj.cell_filter$multiplier),
                              experiment = obj.cell_filter$experiment,
                              run_id = obj.cell_filter$run_id)
row_ha = rowAnnotation(charge = anno_barplot(rowData(obj.cell_filter)$Precursor.Charge))

pdf("MS1.log2_filtered_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(scale(assay(obj.cell_filter, "MS1.log2"), center = FALSE, scale = FALSE),
        top_annotation = column_ha,
        right_annotation = row_ha,
        heatmap_legend_param = list(title = "Log2(MS1 area)"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
df <- colData(obj.cell_filter)
df$multiplier <- factor(df$multiplier)
p <- pca(na.omit(assay(obj.cell_filter, "MS1.log2")),
         metadata = df,
         center = TRUE, 
         scale = TRUE)

screeplot(p)

pdf("MS1.log2_filtered_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "date", "run_id", "multiplier", "total.ms1"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS1.log2_filtered_replicate_pca.pdf",
    width = 4,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'top',
       hline = 0, 
       vline = 0,
       lab = NULL) +
  labs(color = "Replicate",
       shape = "# Cells") +
  theme_Publication() +
  theme(legend.box="vertical", 
        legend.margin=margin())
dev.off()
```

### MS2
```{r}
# transform
assays(obj.cell_filter)[["MS2.log2"]] <- log2(assay(obj.cell_filter, "MS2") + 1)

# imputation
assays(obj.cell_filter)[["MS2.log2.impute"]] <- missForest(assay(obj.cell_filter, "MS2.log2"))$ximp

# plot by cell
df <- assay(obj.cell_filter, "MS2.log2") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj.cell_filter)), by.x = "variable", by.y = "row.names")

pdf("MS2.log2_distribution_filtered_cell.pdf",
    width = 8,
    height = 10)
ggplot(df, aes(x = as.factor(run_id), y = value, fill = as.factor(replicate))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "Log2(MS2 intensity)", fill = "Replicate") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 3)
dev.off()

# plot by peptide
pdf("MS2.log2_distribution_filtered_peptide.pdf",
    width = 15,
    height = 10)
ggplot(df, aes(x = id, y = value)) +
  geom_boxplot() +
  theme_Publication() +
  labs(title = "Cell #", x = "Peptide", y = "Log2(MS2 intensity)", fill = "Replicate") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x")
dev.off()

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.cell_filter$replicate),
                              cell_number = as.factor(obj.cell_filter$multiplier),
                              experiment = obj.cell_filter$experiment,
                              run_id = obj.cell_filter$run_id)
row_ha = rowAnnotation(charge = anno_barplot(rowData(obj.cell_filter)$Precursor.Charge))

pdf("MS2.log2_filtered_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(scale(assay(obj.cell_filter, "MS2.log2"), center = FALSE, scale = FALSE),
        top_annotation = column_ha,
        right_annotation = row_ha,
        heatmap_legend_param = list(title = "Log2(MS2 area)"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
df <- colData(obj.cell_filter)
df$multiplier <- factor(df$multiplier)
data <- assay(obj.cell_filter, "MS2.log2")
data[data == 0] <- NA
p <- pca(na.omit(data),
         metadata = df,
         center = TRUE, 
         scale = TRUE)

screeplot(p)

pdf("MS2.log2_filtered_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "date", "run_id", "multiplier", "total.ms2"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS2.log2_filtered_replicate_pca.pdf",
    width = 4,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'top',
       hline = 0, 
       vline = 0,
       lab = NULL) +
  labs(color = "Replicate",
       shape = "# Cells") +
  theme_Publication() +
  theme(legend.box="vertical", 
        legend.margin=margin())
dev.off()
```

### MS1 vs MS2
```{r}
df.1 <- assay(obj.cell_filter, "MS1.log2.impute") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value")

df.2 <- assay(obj.cell_filter, "MS2.log2.impute") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value")

df <- cbind(df.1, df.2$value)
colnames(df) <- c("id", "variable", "ms1", "ms2")
df <- merge(df, as.data.frame(colData(obj.cell_filter)), by.x = "variable", by.y = "row.names")
df$id <- gsub(";", " ", df$id)

# by cell amount
pdf("MS1_vs_MS2_filtered_type.pdf",
    width = 8,
    height = 8)
ggplot(subset(df, multiplier != "0"), aes(x = ms1, y = ms2, color = as.factor(replicate))) +
  geom_point() +
  stat_smooth(method = "lm") +
  stat_cor() +
  facet_wrap(.~as.factor(multiplier)) +
  labs(title = "", x = "Log2(MS1)", y = "Log2(MS2)") +
  theme_Publication() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_color_discrete(name = "Replicate")
dev.off()

# just single cells
pdf("MS1_vs_MS2_filtered_1cell.pdf",
    width = 5,
    height = 5)
ggplot(subset(df, multiplier == "1"), aes(x = ms1, y = ms2, color = as.factor(replicate))) +
  geom_point() +
  stat_smooth(method = "lm") +
  stat_cor() +
  labs(title = "", x = "Log2(MS1)", y = "Log2(MS2)", color = "Replicate") +
  theme_Publication() +
  guides(color = guide_legend(override.aes = list(shape = 19)))
dev.off()

# facet peptides for single cells
pdf("MS1_vs_MS2_filtered_peptide.pdf",
    width = 25,
    height = 25)
ggplot(subset(df, multiplier == "1"), aes(x = ms1, y = ms2, color = as.factor(replicate))) +
  geom_point() +
  stat_smooth(method = "lm") +
  stat_cor() +
  facet_wrap(.~as.factor(multiplier)) +
  labs(title = "HIstone Peptides", x = "Log2(MS1)", y = "Log2(MS2)") +
  theme_Publication(base_size = 12) +
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
  facet_wrap(.~id, scales = "free", labeller = labeller(id = label_wrap_gen(20))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_color_discrete(name = "Replicate")
dev.off()

# by single cell averages
df.summary <- df %>%
  filter(multiplier == "1") %>%
  group_by(id, replicate) %>%
  summarise(ms1.mean = mean(ms1),
            ms2.mean = mean(ms2))

pdf("MS1_vs_MS2_filtered_peptide_1cell_mean.pdf",
    width = 5,
    height = 5)
ggplot(df.summary, aes(x = ms1.mean, y = ms2.mean, color = as.factor(replicate))) +
  geom_point() +
  stat_smooth(method = "lm") +
  stat_cor() +
  labs(title = "", x = "Log2(MS1)", y = "Log2(MS2)", color = "Replicate") +
  theme_Publication() +
  guides(color = guide_legend(override.aes = aes(label = ""))) +
  geom_text_repel(data = subset(df.summary, ms1.mean > 15 & ms2.mean < 12 & replicate == 1), 
            aes(label = id), max.overlaps	= Inf, color = "black", min.segment.length = 0, alpha = 0.75)
dev.off()
```

### Save object
- re-naming and saving in main folder
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto")

obj.filter <- obj.cell_filter

saveRDS(obj.filter, "obj.filter.RDS")
```

# Normalization

## Median center

### MS1
```{r}
dir.create("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")

# median center normalization
assays(obj.filter)[["MS1.log2.center"]] <- sweep(assay(obj.filter, "MS1.log2"), 2, apply(assay(obj.filter, "MS1.log2"), 2, function(x) median(x, na.rm = TRUE)), FUN = "-")

# imputation
assays(obj.filter)[["MS1.log2.center.impute"]] <- missForest(assay(obj.filter, "MS1.log2.center"))$ximp

# plot by cell
df <- assay(obj.filter, "MS1.log2.center.impute") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj.filter)), by.x = "variable", by.y = "row.names")

pdf("MS1.log2.center.impute_distribution_cell.pdf",
    width = 8,
    height = 8)
ggplot(df, aes(x = as.factor(run_id), y = value, fill = as.factor(replicate))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "Log2(MS1 intensity)", fill = "Replicate") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 2)
dev.off()

# plot by peptide
pdf("MS1.log2.center.impute_distribution_peptide.pdf",
    width = 15,
    height = 10)
ggplot(df, aes(x = id, y = value)) +
  geom_boxplot() +
  theme_Publication() +
  labs(title = "Cell #", x = "Peptide", y = "Log2(MS1 intensity)", fill = "Replicate") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x")
dev.off()

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter$replicate),
                              experiment = obj.filter$experiment,
                              cell_number = as.factor(obj.filter$multiplier),
                              run_id = obj.filter$run_id)
row_ha = rowAnnotation(charge = anno_barplot(rowData(obj.filter)$Precursor.Charge))

pdf("MS1.log2.center.impute_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(scale(assay(obj.filter, "MS1.log2.center.impute"), center = FALSE, scale = FALSE),
        top_annotation = column_ha,
        right_annotation = row_ha,
        heatmap_legend_param = list(title = "Normalized MS1 intensity"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
p <- pca(na.omit(assay(obj.filter, "MS1.log2.center.impute")),
         metadata = colData(obj.filter),
         center = TRUE, 
         scale = TRUE)

screeplot(p)

# pdf("MS1.log2.center.impute_eigencor.pdf",
#     width = 5,
#     height = 5)
# eigencorplot(p,
#              main = "Principle component correlations",
#              cexMain = 1.5,
#              metavars = c("replicate", "date", "run_id", "multiplier", "total.ms1", "experiment"),
#              col = viridis(100),
#              colCorval = 'firebrick',
#              fontCorval = 2,
#              cexCorval = 0.5,
#              rotLabX = 45,
#              posColKey = 'top')
# dev.off()

pdf("MS1.log2.center.impute_replicate_pca.pdf",
    width = 5,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'right',
       hline = 0, 
       vline = 0,
       gridlines.major = FALSE, 
       gridlines.minor = FALSE,
       lab = NULL)
dev.off()
```

### MS2
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")

# median center normalization
assays(obj.filter)[["MS2.log2.center"]] <- sweep(assay(obj.filter, "MS2.log2"), 2, apply(assay(obj.filter, "MS2.log2"), 2, function(x) median(x, na.rm = TRUE)), FUN = "-")

# imputation
assays(obj.filter)[["MS2.log2.center.impute"]] <- missForest(assay(obj.filter, "MS2.log2.center"))$ximp

# plot by cell
df <- assay(obj.filter, "MS2.log2.center.impute") %>% 
  rownames_to_column("id") %>%
  pivot_longer(
    cols = -id, # This keeps the 'id' column fixed
    names_to = "variable",
    values_to = "value") %>%
  merge(as.data.frame(colData(obj.filter)), by.x = "variable", by.y = "row.names")

pdf("MS2.log2.center.impute_distribution_cell.pdf",
    width = 8,
    height = 8)
ggplot(df, aes(x = as.factor(run_id), y = value, fill = as.factor(replicate))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "Log2(MS2 intensity)", fill = "Replicate") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 2)
dev.off()

# plot by peptide
pdf("MS2.log2.center.impute_distribution_peptide.pdf",
    width = 15,
    height = 10)
ggplot(df, aes(x = id, y = value)) +
  geom_boxplot() +
  theme_Publication() +
  labs(title = "Cell #", x = "Peptide", y = "Log2(MS2 intensity)", fill = "Replicate") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x")
dev.off()

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter$replicate),
                              experiment = obj.filter$experiment,
                              cell_number = as.factor(obj.filter$multiplier),
                              run_id = obj.filter$run_id)
row_ha = rowAnnotation(charge = anno_barplot(rowData(obj.filter)$Precursor.Charge))

pdf("MS2.log2.center.impute_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(scale(assay(obj.filter, "MS2.log2.center.impute"), center = FALSE, scale = FALSE),
        top_annotation = column_ha,
        right_annotation = row_ha,
        heatmap_legend_param = list(title = "Normalized MS2 intensity"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
p <- pca(na.omit(assay(obj.filter, "MS2.log2.center.impute")),
         metadata = colData(obj.filter),
         center = TRUE, 
         scale = TRUE)

screeplot(p)

# pdf("MS2.log2.center.impute_eigencor.pdf",
#     width = 5,
#     height = 5)
# eigencorplot(p,
#              main = "Principle component correlations",
#              cexMain = 1.5,
#              metavars = c("replicate", "date", "run_id", "multiplier", "total.ms2", "experiment"),
#              col = viridis(100),
#              colCorval = 'firebrick',
#              fontCorval = 2,
#              cexCorval = 0.5,
#              rotLabX = 45,
#              posColKey = 'top')
# dev.off()

pdf("MS2.log2.center.impute_replicate_pca.pdf",
    width = 5,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'right',
       hline = 0, 
       vline = 0,
       gridlines.major = FALSE, 
       gridlines.minor = FALSE,
       lab = NULL)
dev.off()
```

### Save object
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto")

saveRDS(obj.filter, "obj.filter.RDS")
```

### Output normalized intensities
```{r}
dir.create("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/tables")
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/tables")

write.csv(assay(obj.filter, "MS1.log2.center.impute"), "MS1.log2.center.impute.csv")
write.csv(assay(obj.filter, "MS2.log2.center.impute"), "MS2.log2.center.impute.csv")
```

## Normalize by peptide with no modification sites
- This is how it is done in the LINCS project (Malivina)
- H3(41-49), Y[+56]RPGTVALR and H4(68-78) D[+56]AVTYTEHAK[+56]R
- Not done since signal of these peptides too low


## Peptide ratio
- group all histones ptms from same peptide
- filter out peptides which only have a single unmod/ptm
- calculate ratio of each ptm to all of ptms with same peptide

### MS1 ratio
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")

ptm.ratio.ms1 <- calculate_ptm_ratio(obj.filter, assay = "MS1")

pdf("MS1.ratio_cell.pdf",
    width = 8,
    height = 8)
ggplot(ptm.ratio.ms1, aes(x = as.factor(run_id), y = ratio, fill = as.factor(experiment))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "MS1 peptide ratio", fill = "Experiment") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 2)
dev.off()

pdf("MS1.ratio.log1p_cell.pdf",
    width = 8,
    height = 8)
ggplot(ptm.ratio.ms1, aes(x = as.factor(run_id), y = ratio.log1p, fill = as.factor(experiment))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "MS1 peptide ratio", fill = "Experiment") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 2)
dev.off()
```

### MS2 ratio
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")

ptm.ratio.ms2 <- calculate_ptm_ratio(obj.filter, assay = "MS2")

pdf("MS2.ratio_cell.pdf",
    width = 8,
    height = 8)
ggplot(ptm.ratio.ms2, aes(x = as.factor(run_id), y = ratio, fill = as.factor(experiment))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "MS2 peptide ratio", fill = "Experiment") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 2)
dev.off()

pdf("MS2.ratio.log1p_cell.pdf",
    width = 8,
    height = 8)
ggplot(ptm.ratio.ms2, aes(x = as.factor(run_id), y = ratio.log1p, fill = as.factor(experiment))) +
  geom_boxplot(width = 0.7) +
  theme_Publication() +
  labs(title = "Cell #", x = "Run", y = "MS2 peptide ratio", fill = "Experiment") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) +
  facet_wrap(.~as.factor(multiplier), scales = "free_x", nrow = 2)
dev.off()
```

### Single PTM ratios
- summing percentages of same types of mods on same amino acid across peptides
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")

sptm.ratio.ms1 <- calculate_single_ptm_ratio(ptm.ratio.ms1, input = "long")
sptm.ratio.ms1.log1p <- log1p(sptm.ratio.ms1)
```

### Global PTM ratios
- Summing percentages of MS1
- Improvement: Use raw MS1 values to calculate new percentages
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")

global.ratio.ms1 <- calculate_global_ptm_ratio(sptm.ratio.ms1)
global.ratio.ms1.log1p <- log1p(global.ratio.ms1)
```

### Summarized H4 PTM ratios
- Summing percentages of MS1 for each combo of peptides: mono, di, tri, tetra
- Improvement: Use raw MS1 values to calculate new percentages
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")

h4.ac.ratio.ms1 <- calculate_h4_ac_summary_ratio(ptm.ratio.ms1, input = "long")
h4.ac.ratio.ms1.log1p <- log1p(h4.ac.ratio.ms1)
```

### Create new multi assay experiment
- Must create new one since number of peptides is different than previous object
- Using multi assay experiment to hold the summarized ratios
- IMPROVEMENT: add sample map
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")

# create summarized experiment from ratios
obj.filter.ratio <- load_ratio_summarized_experiment(ptm.ratio.ms1, 
                                                     ptm.ratio.ms2, 
                                                     obj.filter)

# create sample map for adding in other matrices
# map <- data.frame(
#     primary = colnames(obj.filter.ratio),
#     colnames = colnames(obj.filter.ratio),
#     stringsAsFactors = FALSE)
# 
# maplist <- list(ptm.ratio = map, 
#                 sptm.ratio = map,
#                 global.ratio = map,
#                 h4.ac.ratio = map)
# 
# sampMap <- listToMap(maplist)

# create multi assay experiment that contains multiple summarized experiments 
obj.filter.ratio.multi <- MultiAssayExperiment(experiments = ExperimentList(list(ptm.ratio = obj.filter.ratio,
                                                                sptm.ratio = SummarizedExperiment(list(MS1.ratio = sptm.ratio.ms1,
                                                                                                       MS1.ratio.log1p = sptm.ratio.ms1.log1p)),
                                                                global.ratio = SummarizedExperiment(list(MS1.ratio = global.ratio.ms1,
                                                                                                         MS1.ratio.log1p = global.ratio.ms1.log1p)),
                                                                h4.ac.ratio = SummarizedExperiment(list(MS1.ratio = h4.ac.ratio.ms1,
                                                                                                        MS1.ratio.log1p = h4.ac.ratio.ms1.log1p)))),
                                               colData = colData(obj.filter.ratio))
```

### Visualize

#### MS1 ratio
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              experiment = obj.filter.ratio.multi$experiment,
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              condition = obj.filter.ratio.multi$condition,
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.log1p_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["ptm.ratio"]], "MS1.ratio.log1p"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "MS1 Peptide Ratio"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
p <- pca(assay(experiments(obj.filter.ratio.multi)[["ptm.ratio"]], "MS1.ratio.log1p"),
         metadata = colData(obj.filter.ratio.multi),
         center = TRUE, 
         scale = TRUE)

pdf("MS1.ratio.log1p_screeplot.pdf",
    width = 5,
    height = 5)
screeplot(p,
          components = getComponents(p)[1:10])
dev.off()

pdf("MS1.ratio.log1p_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "run_id", "multiplier", "total.ms1"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS1.ratio.log1p_replicate_pca.pdf",
    width = 5,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'top',
       hline = 0, 
       vline = 0,
       lab = NULL) +
  labs(color = "Replicate",
       shape = "Multiplier") +
  theme_Publication() +
  theme(legend.box="vertical", 
        legend.margin=margin())
dev.off()
```

#### MS2 ratio
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio$replicate),
                              experiment = obj.filter.ratio$experiment,
                              cell_number = as.factor(obj.filter.ratio$multiplier),
                              condition = obj.filter.ratio$condition,
                              run_id = obj.filter.ratio$run_id)

pdf("MS2.ratio.log1p_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["ptm.ratio"]], "MS2.ratio.log1p"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "MS2 Peptide Ratio"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
p <- pca(assay(experiments(obj.filter.ratio.multi)[["ptm.ratio"]], "MS2.ratio.log1p"),
         metadata = colData(obj.filter.ratio),
         center = TRUE, 
         scale = TRUE)

pdf("MS2.ratio.log1p_screeplot.pdf",
    width = 5,
    height = 5)
screeplot(p,
          components = getComponents(p)[1:10])
dev.off()

pdf("MS2.ratio.log1p_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "run_id", "multiplier", "total.ms2"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS2.ratio.log1p_replicate_pca.pdf",
    width = 5,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'top',
       hline = 0, 
       vline = 0,
       lab = NULL) +
  labs(color = "Replicate",
       shape = "Multiplier") +
  theme_Publication() +
  theme(legend.box="vertical", 
        legend.margin=margin())
dev.off()
```

#### Single PTM ratio
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              experiment = obj.filter.ratio.multi$experiment,
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              condition = obj.filter.ratio.multi$condition,
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.single_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["sptm.ratio"]], "MS1.ratio"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

pdf("MS1.ratio.log1p.single_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["sptm.ratio"]], "MS1.ratio.log1p"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()
```

#### Global PTM ratio
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              experiment = obj.filter.ratio.multi$experiment,
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              condition = obj.filter.ratio.multi$condition,
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.global_heatmap.pdf",
    width = 10,
    height = 3)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["global.ratio"]], "MS1.ratio"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

pdf("MS1.ratio.log1p.global_heatmap.pdf",
    width = 10,
    height = 3)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["global.ratio"]], "MS1.ratio.log1p"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()
```

#### Summarized H4 PTM ratio
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/normalization")

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              experiment = obj.filter.ratio.multi$experiment,
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              condition = obj.filter.ratio.multi$condition,
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.h4_heatmap.pdf",
    width = 10,
    height = 3)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["h4.ac.ratio"]], "MS1.ratio"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

pdf("MS1.ratio.log1p.h4_heatmap.pdf",
    width = 10,
    height = 3)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["h4.ac.ratio"]], "MS1.ratio.log1p"),
        top_annotation = column_ha,
        #right_annotation = row_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()
```

### Save object
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto")

saveRDS(obj.filter.ratio.multi, "obj.filter.ratio.multi.RDS")
```

### Output tables
```{r}
dir.create("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/tables")
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/tables")

write.csv(assay(obj.filter.ratio.multi[["ptm.ratio"]], "RT"), "RT.csv")

# untransformed
write.csv(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio"), "MS1.ratio.csv")
write.csv(assay(obj.filter.ratio.multi[["sptm.ratio"]], "MS1.ratio"), "MS1.ratio.single.csv")
write.csv(assay(obj.filter.ratio.multi[["global.ratio"]], "MS1.ratio"), "MS1.ratio.global.csv")
write.csv(assay(obj.filter.ratio.multi[["h4.ac.ratio"]], "MS1.ratio"), "MS1.ratio.h4.csv")

# transformed
write.csv(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio.log1p"), "MS1.ratio.log1p.csv")
write.csv(assay(obj.filter.ratio.multi[["sptm.ratio"]], "MS1.ratio.log1p"), "MS1.ratio.log1p.single.csv")
write.csv(assay(obj.filter.ratio.multi[["global.ratio"]], "MS1.ratio.log1p"), "MS1.ratio.log1p.global.csv")
write.csv(assay(obj.filter.ratio.multi[["h4.ac.ratio"]], "MS1.ratio.log1p"), "MS1.ratio.log1p.h4.csv")
```

# Batch correction

## Median center

### MS1
```{r}
dir.create("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/batch-corrected")
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/batch-corrected")
# assess batch effects
# batchQC(assay(obj.filter, "MS1.log2.center"), obj.filter$replicate, NULL,
#         report_file="MS1.log2.center.no-correction.html", report_dir=".",
#         report_option_binary="111111111",
#         view_report=FALSE, interactive=FALSE, batchqc_output=FALSE)

# correct batch using combat
# keeping the number of cells and condition be variables of interest
# pdata <- data.frame(colnames(obj.filter), obj.filter$replicate, obj.filter$multiplier)
# modmatrix = model.matrix(~as.integer(obj.filter$multiplier), data=pdata)
# assays(obj.filter, withDimnames=FALSE)[["MS1.log2.center.impute.batchCorrect"]] <- as.data.frame(ComBat(dat = assay(obj.filter, "MS1.log2.center"), 
#                                                                batch = obj.filter$replicate, 
#                                                                mod = modmatrix, 
#                                                                ref.batch = 1))

# assess correction
# batchQC(assay(obj.filter, "MS1.log2.center.impute.batchCorrect"), obj.filter$replicate, as.integer(obj.filter$condition),
#         report_file="MS1.log2.center.correction.html", report_dir=".",
#         report_option_binary="111111111",
#         view_report=FALSE, interactive=FALSE, batchqc_output=FALSE)

assays(obj.filter, withDimnames=FALSE)[["MS1.log2.center.impute.batchCorrect"]] <- removeBatchEffect(assay(obj.filter, "MS1.log2.center.impute"),
                                                                                                       batch = obj.filter$replicate)


# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter$replicate),
                              cell_number = as.factor(obj.filter$multiplier))
row_ha = rowAnnotation(charge = anno_barplot(rowData(obj.filter)$Precursor.Charge))

pdf("MS1.log2.center.impute.batchCorrect_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(scale(assay(obj.filter, "MS1.log2.center.impute.batchCorrect"), center = FALSE, scale = FALSE),
        top_annotation = column_ha,
        right_annotation = row_ha,
        heatmap_legend_param = list(title = "Log2(MS2 area)"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
p <- pca(na.omit(assay(obj.filter, "MS1.log2.center.impute.batchCorrect")),
         metadata = colData(obj.filter),
         center = TRUE, 
         scale = TRUE)

screeplot(p)

pdf("MS1.log2.center.impute.batchCorrect_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "date", "run_id", "multiplier"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS1.log2.center.impute.batchCorrect_replicate_pca.pdf",
    width = 5,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'top',
       hline = 0, 
       vline = 0,
       lab = NULL) +
  labs(color = "Replicate",
       shape = "# Cells") +
  theme_Publication() +
  theme(legend.box="vertical", 
        legend.margin=margin())
dev.off()
```

### MS2
```{r}
dir.create("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/batch-corrected")
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/batch-corrected")
# assess batch effects
# batchQC(assay(obj.filter, "MS2.log2.center"), obj.filter$replicate, NULL,
#         report_file="MS2.log2.center.no-correction.html", report_dir=".",
#         report_option_binary="111111111",
#         view_report=FALSE, interactive=FALSE, batchqc_output=FALSE)

# correct batch using combat
# keeping the number of cells and condition be variables of interest
# pdata <- data.frame(colnames(obj.filter), obj.filter$replicate, obj.filter$multiplier)
# modmatrix = model.matrix(~as.integer(obj.filter$multiplier), data=pdata)
# assays(obj.filter, withDimnames=FALSE)[["MS2.log2.center.impute.batchCorrect"]] <- as.data.frame(ComBat(dat = assay(obj.filter, "MS2.log2.center"), 
#                                                                batch = obj.filter$replicate, 
#                                                                mod = modmatrix, 
#                                                                ref.batch = 1))

# assess correction
# batchQC(assay(obj.filter, "MS2.log2.center.impute.batchCorrect"), obj.filter$replicate, as.integer(obj.filter$condition),
#         report_file="MS2.log2.center.correction.html", report_dir=".",
#         report_option_binary="111111111",
#         view_report=FALSE, interactive=FALSE, batchqc_output=FALSE)

assays(obj.filter, withDimnames=FALSE)[["MS2.log2.center.impute.batchCorrect"]] <- removeBatchEffect(assay(obj.filter, "MS2.log2.center.impute"),
                                                                                                       batch = obj.filter$replicate)


# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter$replicate),
                              cell_number = as.factor(obj.filter$multiplier))
row_ha = rowAnnotation(charge = anno_barplot(rowData(obj.filter)$Precursor.Charge))

pdf("MS2.log2.center.impute.batchCorrect_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(scale(assay(obj.filter, "MS2.log2.center.impute.batchCorrect"), center = FALSE, scale = FALSE),
        top_annotation = column_ha,
        right_annotation = row_ha,
        heatmap_legend_param = list(title = "Log2(MS2 area)"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
p <- pca(na.omit(assay(obj.filter, "MS2.log2.center.impute.batchCorrect")),
         metadata = colData(obj.filter),
         center = TRUE, 
         scale = TRUE)

screeplot(p)

pdf("MS2.log2.center.impute.batchCorrect_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "date", "run_id", "multiplier"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS2.log2.center.impute.batchCorrect_replicate_pca.pdf",
    width = 5,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'top',
       hline = 0, 
       vline = 0,
       lab = NULL) +
  labs(color = "Replicate",
       shape = "# Cells") +
  theme_Publication() +
  theme(legend.box="vertical", 
        legend.margin=margin())
dev.off()
```

### Save object
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto")

saveRDS(obj.filter, "obj.filter.RDS")
```

### Output normalized intensities
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/tables")

write.csv(assay(obj.filter, "MS1.log2.center.impute.batchCorrect"), "MS1.log2.center.impute.batchCorrect.csv")
write.csv(assay(obj.filter, "MS2.log2.center.impute.batchCorrect"), "MS2.log2.center.impute.batchCorrect.csv")
```

## Peptide ratio

### MS1
```{r}
dir.create("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/batch-corrected")
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/batch-corrected")

assays(obj.filter.ratio.multi[["ptm.ratio"]], withDimnames=FALSE)[["MS1.ratio.log1p.batchCorrect"]] <- 
  removeBatchEffect(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio.log1p"),
                    batch = obj.filter.ratio.multi$replicate)

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              run_id = obj.filter.ratio.multi$run_id)
row_ha = rowAnnotation(charge = anno_barplot(rowData(obj.filter.ratio.multi[["ptm.ratio"]])$Precursor.Charge))

pdf("MS1.ratio.log1p.batchCorrect_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio.log1p.batchCorrect"),
        top_annotation = column_ha,
        right_annotation = row_ha,
        heatmap_legend_param = list(title = "Normalized Peptide Ratio"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
p <- pca(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio.log1p.batchCorrect"),
         metadata = colData(obj.filter.ratio.multi),
         center = TRUE, 
         scale = TRUE)

pdf("MS1.ratio.log1p.batchCorrect_screeplot.pdf",
    width = 5,
    height = 5)
screeplot(p,
          components = getComponents(p)[1:10])
dev.off()

pdf("MS1.ratio.log1p.batchCorrect_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "date", "run_id", "multiplier", "total.ms1"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS1.ratio.log1p.batchCorrect_replicate_pca.pdf",
    width = 4,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'top',
       hline = 0, 
       vline = 0,
       lab = NULL) +
  labs(color = "Replicate",
       shape = "Multiplier") +
  theme_Publication() +
  theme(legend.box="vertical", 
        legend.margin=margin())
dev.off()

pdf("MS1.ratio.log1p.batchCorrect_replicate_pca_pairs.pdf",
    width = 5,
    height = 5)
pairsplot(p,
          components = getComponents(p, seq_len(3)),
          colby = "replicate", 
          shape = "multiplier",
          hline = 0, 
          vline = 0,
          lab = NULL)
dev.off()
```

### MS2
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/batch-corrected")

assays(obj.filter.ratio.multi[["ptm.ratio"]], withDimnames=FALSE)[["MS2.ratio.log1p.batchCorrect"]] <- 
  removeBatchEffect(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS2.ratio.log1p"),
                    batch = obj.filter.ratio.multi$replicate)

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              run_id = obj.filter.ratio.multi$run_id)
row_ha = rowAnnotation(charge = anno_barplot(rowData(obj.filter.ratio.multi[["ptm.ratio"]])$Precursor.Charge))

pdf("MS2.ratio.log1p.batchCorrect_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS2.ratio.log1p.batchCorrect"),
        top_annotation = column_ha,
        right_annotation = row_ha,
        heatmap_legend_param = list(title = "Normalized Peptide Ratio"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()

# PCA
p <- pca(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS2.ratio.log1p.batchCorrect"),
         metadata = colData(obj.filter.ratio.multi),
         center = TRUE, 
         scale = TRUE)

pdf("MS2.ratio.log1p.batchCorrect_screeplot.pdf",
    width = 5,
    height = 5)
screeplot(p,
          components = getComponents(p)[1:10])
dev.off()

pdf("MS2.ratio.log1p.batchCorrect_eigencor.pdf",
    width = 5,
    height = 5)
eigencorplot(p,
             main = "Principle component correlations",
             cexMain = 1.5,
             metavars = c("replicate", "date", "run_id", "multiplier", "total.ms2"),
             col = viridis(100),
             colCorval = 'firebrick',
             fontCorval = 2,
             cexCorval = 0.5,
             rotLabX = 45,
             posColKey = 'top')
dev.off()

pdf("MS2.ratio.log1p.batchCorrect_replicate_pca.pdf",
    width = 5,
    height = 5)
biplot(p,
       colby = "replicate", 
       shape = "multiplier",
       legendPosition = 'top',
       hline = 0, 
       vline = 0,
       lab = NULL) +
  labs(color = "Replicate",
       shape = "Multiplier") +
  theme_Publication() +
  theme(legend.box="vertical", 
        legend.margin=margin())
dev.off()
```

### Single PTM ratio
- Recalculate using new batch corrected ms1 ratios
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/batch-corrected")

assays(obj.filter.ratio.multi[["sptm.ratio"]], withDimnames=FALSE)[["MS1.ratio.log1p.batchCorrect"]] <- 
  removeBatchEffect(assay(obj.filter.ratio.multi[["sptm.ratio"]], "MS1.ratio.log1p"),
                    batch = obj.filter.ratio.multi$replicate)

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.log1p.batchCorrect.single_heatmap.pdf",
    width = 10,
    height = 10)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["sptm.ratio"]], "MS1.ratio.log1p.batchCorrect"),
        top_annotation = column_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()
```

### Global PTM ratio
- Recalculate using new batch corrected ms1 ratios
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/batch-corrected")

assays(obj.filter.ratio.multi[["global.ratio"]], withDimnames=FALSE)[["MS1.ratio.log1p.batchCorrect"]] <- 
  removeBatchEffect(assay(obj.filter.ratio.multi[["global.ratio"]], "MS1.ratio.log1p"),
                    batch = obj.filter.ratio.multi$replicate)

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.log1p.batchCorrect.global_heatmap.pdf",
    width = 10,
    height = 3)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["global.ratio"]], "MS1.ratio.log1p.batchCorrect"),
        top_annotation = column_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()
```

### Summarized H4 PTM ratio
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/batch-corrected")

assays(obj.filter.ratio.multi[["h4.ac.ratio"]], withDimnames=FALSE)[["MS1.ratio.log1p.batchCorrect"]] <- 
  removeBatchEffect(assay(obj.filter.ratio.multi[["h4.ac.ratio"]], "MS1.ratio.log1p"),
                    batch = obj.filter.ratio.multi$replicate)

# heatmap
column_ha = HeatmapAnnotation(replicate = as.factor(obj.filter.ratio.multi$replicate),
                              cell_number = as.factor(obj.filter.ratio.multi$multiplier),
                              run_id = obj.filter.ratio.multi$run_id)

pdf("MS1.ratio.log1p.batchCorrect.h4_heatmap.pdf",
    width = 10,
    height = 3)
set.seed(123)
Heatmap(assay(experiments(obj.filter.ratio.multi)[["h4.ac.ratio"]], "MS1.ratio.log1p.batchCorrect"),
        top_annotation = column_ha,
        heatmap_legend_param = list(title = "PTM relative abundance"),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_column_names = FALSE,
        row_names_gp = gpar(fontsize = 10))
dev.off()
```

### Save object
```{r}
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto")

saveRDS(obj.filter.ratio.multi, "obj.filter.ratio.multi.RDS")
```

### Output tables
```{r}
dir.create("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/tables")
setwd("/Users/ronaldcutler/Dropbox\ (EinsteinMed)/Sidoli-lab/Projects/Single-cell-histone/Analysis/4-normalization/auto/tables")

write.csv(assay(obj.filter.ratio.multi[["ptm.ratio"]], "MS1.ratio.log1p.batchCorrect"), "MS1.ratio.log1p.batchCorrect.csv")
write.csv(assay(obj.filter.ratio.multi[["sptm.ratio"]], "MS1.ratio.log1p.batchCorrect"), "MS1.ratio.log1p.batchCorrect.csv")
write.csv(assay(obj.filter.ratio.multi[["global.ratio"]], "MS1.ratio.log1p.batchCorrect"), "MS1.ratio.log1p.batchCorrect.csv")
write.csv(assay(obj.filter.ratio.multi[["h4.ac.ratio"]], "MS1.ratio.log1p.batchCorrect"), "MS1.ratio.log1p.batchCorrect.csv")
```